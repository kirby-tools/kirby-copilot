var nn=Object.defineProperty;var rn=(c,y,A)=>y in c?nn(c,y,{enumerable:!0,configurable:!0,writable:!0,value:A}):c[y]=A;var X=(c,y,A)=>rn(c,typeof y!="symbol"?y+"":y,A);(function(){"use strict";const c=window.Vue;function y(){return window.panel}function A(){return y().api}const Q=()=>window.panel.plugins.viewButtons!==void 0;function Le(){const o=y().app.$store;return o||new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}})}function le(){const o=y(),t=Le(),r=Q(),e=I(r?()=>o.view.props.content:()=>t.getters["content/values"]()),n=I(r?()=>o.content.changes():()=>t.getters["content/changes"]()),s=I(r?()=>Object.keys(n.value).length>0:()=>t.getters["content/hasChanges"]()),i=r?o.content:new Proxy({},{get(){return()=>{}}});return{content:i,currentContent:e,contentChanges:n,hasChanges:s,update:async(a,d=!0)=>{if(!r&&a)for(const[f,l]of Object.entries(a))t.dispatch("content/update",[f,l]);const u=i.merge(a);d&&await i.save(u)}}}function Ee(){const o=A();return{load:({parent:r,name:e})=>o.get(`${r}/sections/${e}`)}}const $e={error:0,warn:1,log:2,info:3,success:3};function ze(o){const t=new je;return new Proxy({},{get(r,e){return(...n)=>{t.log({level:$e[e],type:e,tag:o,args:n})}}})}class je{constructor(){X(this,"defaultColor","#7f8c8d");X(this,"levelColorMap",{0:"#c0392b",1:"#f39c12",3:"#00BCD4"});X(this,"typeColorMap",{success:"#2ecc71"})}log(t){const r=Te(t.level),e=t.type==="log"?"":t.type,n=t.tag||"",i=`
background: ${this.typeColorMap[t.type]||this.levelColorMap[t.level]||this.defaultColor};
border-radius: 0.5em;
color: white;
font-weight: bold;
padding: 2px 0.5em;
`.trimStart(),p=`%c${[n,e].filter(Boolean).join(":")}`;typeof t.args[0]=="string"?r(`${p}%c ${t.args[0]}`,i,"",...t.args.slice(1)):r(p,i,...t.args)}}function Te(o){return o<1?console.error:console.log}const q=[],Z=new Map;async function Ae(o){if(!Array.isArray(o))throw new TypeError(`Expected an array, got ${typeof o}`);for(const t of o)q.some(r=>r.filename===t.filename)||q.push(t)}function ue(o){if(q.length===0)throw new Error("Plugin assets not registered");const t=q.find(r=>r.filename===o);if(!t)throw new Error(`Plugin asset "${o}" not found`);return t}async function G(o){if(o.endsWith(".js")||(o+=".js"),Z.has(o))return Z.get(o);const r=await import(ue(o).url);return Z.set(o,r),r}const I=c.computed;c.customRef,c.defineAsyncComponent,c.defineComponent,c.effectScope,c.getCurrentInstance;const Ie=c.getCurrentScope;c.h,c.inject,c.isProxy,c.isReactive,c.isReadonly,c.isRef,c.isShallow,c.markRaw;const Fe=c.nextTick;c.onActivated,c.onBeforeMount;const Me=c.onBeforeUnmount;c.onBeforeUpdate,c.onDeactivated,c.onErrorCaptured;const Oe=c.onMounted;c.onRenderTracked,c.onRenderTriggered;const Re=c.onScopeDispose;c.onServerPrefetch,c.onUnmounted,c.onUpdated,c.provide,c.proxyRefs,c.reactive,c.readonly;const m=c.ref;c.shallowReactive,c.shallowReadonly,c.shallowRef,c.toRaw,c.toRef,c.toRefs,c.triggerRef;const ee=c.unref;c.useAttrs,c.useCssModule,c.useCssVars,c.useListeners,c.useSlots;const V=c.watch;c.watchEffect,c.watchPostEffect,c.watchSyncEffect;const te={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Find your order number</a> on Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.unauthorized":"Email address or order ID is incorrect","modal.error.invalid.licenseKey":"License key invalid for this plugin","modal.error.incompatible":"License key invalid for this plugin version","modal.error.upgradeable":"License key invalid for this plugin version. Upgrade now on https://hub.kirby.tools.","modal.error.registered":"License key already registered",activate:"Activate",activated:"Plugin activated",buy:"Buy a license",upgrade:"Upgrade"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Finde deine Bestellnummer</a> bei Lemon Squeezy oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.unauthorized":"E-Mail-Adresse oder Bestellnummer ist falsch","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin","modal.error.incompatible":"Lizenzschlüssel ungültig für diese Plugin-Version","modal.error.upgradeable":"Lizenzschlüssel ungültig für diese Plugin-Version. Aktualisiere jetzt auf https://hub.kirby.tools.","modal.error.registered":"Lizenzschlüssel bereits registriert",activate:"Aktivieren",activated:"Plugin aktiviert",buy:"Lizenz kaufen",upgrade:"Upgrade"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Trouvez votre numéro de commande</a> sur Lemon Squeezy ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.unauthorized":"Adresse e-mail ou numéro de commande incorrect","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin","modal.error.incompatible":"Clé de licence invalide pour cette version du plugin","modal.error.upgradeable":"Clé de licence invalide pour cette version du plugin. Mettez à niveau maintenant sur https://hub.kirby.tools.","modal.error.registered":"Clé de licence déjà enregistrée",activate:"Activer",activated:"Plugin activé",buy:"Acheter une licence",upgrade:"Upgrade"},nl:{"modal.info":"Bedankt voor het kopen van {label}! Voer je e-mailadres en bestelnummer in om je licentie te activeren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Vind je bestelnummer</a> op Lemon Squeezy of <a href="mailto:hello@kirby.tools">neem contact met ons op</a> als je het niet kunt vinden.',"modal.error.required.fields":"E-mailadres en bestelnummer zijn verplicht","modal.error.invalid.unauthorized":"E-mailadres of bestelnummer is onjuist","modal.error.invalid.licenseKey":"Licentiesleutel ongeldig voor dit plug-in","modal.error.incompatible":"Licentiesleutel ongeldig voor deze plug-inversie","modal.error.upgradeable":"Licentiesleutel ongeldig voor deze plug-inversie. Upgrade nu op https://hub.kirby.tools.","modal.error.registered":"Licentiesleutel al geregistreerd",activate:"Activeren",activated:"Plugin geactiveerd",buy:"Koop een licentie",upgrade:"Upgrade"}},De=["localhost","127.0.0.1","[::1]"],Ue=["local","test","ddev.site"];function F(o="",t){var n;const r=window.panel.translation.code,e=((n=te==null?void 0:te[r])==null?void 0:n[o])??o;return t?Ke(e,t):e}function Ke(o,t,r){return o.replace(/\{(\w+)\}/g,(e,n)=>t[n]||n)}function He(){const{hostname:o}=window.location,t=De.includes(o),r=Ue.some(e=>o.endsWith(`.${e}`));return t||r}const pe={Unauthorized:"modal.error.invalid.unauthorized","License key not valid for this plugin":"modal.error.invalid.licenseKey","License key not valid for this plugin version":"modal.error.incompatible","License key not valid for this plugin version, please upgrade your license":"modal.error.upgradeable","License key already registered":"modal.error.registered"};function Ne(o){const t=y();return{isLocalhost:He(),assertActivationIntegrity:async({component:s,licenseStatus:i})=>{if(ee(i)==="active")return;const p=ee(s);if(!(p!=null&&p.$el)||window.getComputedStyle(p.$el).display==="none"||window.getComputedStyle(p.$el).visibility==="hidden"||window.getComputedStyle(p.$el).opacity==="0")throw new Error("Are you trying to hide the activation buttons? Please buy a license.")},openLicenseModal:()=>{let s=!1;const{label:i}=o,p={info:{type:"info",text:F("modal.info",{label:i})},email:{label:t.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:F("modal.fields.orderId.help",{label:i})}};return new Promise(a=>{t.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:F("activate",{label:i})},fields:p},on:{close:()=>{a({isLicenseActive:s})},submit:async d=>{s=await qe(d,o),s&&(t.dialog.close(),t.notification.success(F("activated")))}}})})}}}async function qe(o,t){const r=y(),{email:e,orderId:n}=o;if(!e||!n)return r.notification.error(F("modal.error.required.fields")),!1;try{const s=await r.api.post(`${t.apiNamespace}/register`,{email:e,orderId:Number(n)});if((s==null?void 0:s.status)!=="ok")throw new Error("Failed to register license");return!0}catch(s){const i=s.message;return r.notification.error(pe[i]?F(pe[i]):i),!1}}const Ge=Vue.defineComponent({__name:"LicensingButtonGroup",props:{label:{type:String,required:!0},apiNamespace:{type:String,required:!0},licenseStatus:{type:String,required:!0},pricingUrl:{type:String,required:!0}},setup(o){const t=o,{openLicenseModal:r,assertActivationIntegrity:e}=Ne({label:t.label,apiNamespace:t.apiNamespace}),n=m(t.licenseStatus),s=m();Oe(()=>{e({component:s,licenseStatus:t.licenseStatus})});async function i(){const{isLicenseActive:p}=await r();p&&window.location.reload()}return{__sfc:!0,props:t,openLicenseModal:r,assertActivationIntegrity:e,currentLicenseStatus:n,licenseButtonGroup:s,handleRegistration:i,t:F}}});function W(o,t,r,e,n,s,i,p){var a=typeof o=="function"?o.options:o;return t&&(a.render=t,a.staticRenderFns=r,a._compiled=!0),s&&(a._scopeId="data-v-"+s),{exports:o,options:a}}var Ve=function(){var t=this,r=t._self._c,e=t._self._setupProxy;return e.currentLicenseStatus!=="active"?r("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[r("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:e.currentLicenseStatus==="upgradeable"?"https://hub.kirby.tools":t.pricingUrl,target:"_blank",text:e.currentLicenseStatus==="upgradeable"?e.t("upgrade"):e.t("buy")}}),r("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.t("activate")},on:{click:function(n){return e.handleRegistration()}}})],1):t._e()},We=[],Je=W(Ge,Ve,We,!1,null,null);const de=Je.exports,Ye={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},Xe="__copilot__/context",fe=["anthropic","mistral","openai"],ne=["image/png","image/jpeg","image/webp","image/gif"],Qe=["error","warn","info","debug"],Ze="kirby$copilot$",me=`
You are an AI assistant integrated into a Content Management System (CMS). Your primary task is to answer user questions accurately and helpfully.

Instructions:
- If selected_text is provided, consider the selected text as context for the user's question.
- If pdf_documents are provided, additional context from PDF documents have been processed and made available to you. Consider the information from these documents as applicable.

Output Format:
- If response_format is set to "text", format your response in plain text. Do not include any Markdown syntax.
- If response_format is set to "HTML", format your response using HTML syntax. Do not include any other parts of a full HTML document structure, except for the content of the <body> element. Structure your response using appropriate HTML tags. Use <h2> or <h3> tags for section headings.
- If response_format is set to "markdown", format your response using Markdown syntax. Do not use backticks or any other wrapping characters around your response.
`;let D;async function et(o){const t=await nt(),r=await o.arrayBuffer(),e=await t.getDocument({data:r,useSystemFonts:!0}).promise;return(await Promise.all(Array.from({length:e.numPages},(s,i)=>tt(e,i+1)))).map(s=>s.replace(/\s+/g," ")).join(`
`)}async function tt(o,t){return(await(await o.getPage(t)).getTextContent()).items.filter(n=>n.str!=null).map(n=>n.str).join(" ")}async function nt(){if(D)return D;D=await G("pdfjs");const o=ue("pdfjs.worker.js");return D.GlobalWorkerOptions.workerSrc=o.url,D}function rt(o,t,r){return o.replace(/\{\s*(\w+)\s*\}/g,(e,n)=>t[n.toLowerCase()]||n)}function ot(){const{currentContent:o}=le(),t={...o.value,title:window.panel.view.title};return Object.fromEntries(Object.entries(t).map(([r,e])=>[r,Array.isArray(e)||typeof e=="object"&&e!==null?JSON.stringify(e):e]))}let it;function st(){return it??(it=ze("copilot"))}let J,U;function re(){return J||U||(U=window.panel.api.get(Xe).then(o=>(Ae(o.assets),J=o,U=void 0,J)),U)}async function he({userPrompt:o,systemPrompt:t,files:r=[],logLevel:e=1,abortSignal:n}){var w,$;const s=st();let{config:i}=await re();if(!i.provider||!fe.includes(i.provider))throw new Error(`Unsupported provider "${i.provider}" in the "johannschopplich.copilot.provider" global configuration.`);for(const v of["apiKey","model"])if(!(($=(w=i.providers)==null?void 0:w[i.provider])!=null&&$[v]))throw new Error(`Missing "${v}" property in the "johannschopplich.copilot.providers.${i.provider}" global configuration.`);const{createAnthropic:p,createMistral:a,createOpenAI:d,streamText:u}=await G("ai"),f=i.provider,l=i.providers[f],_={mistral:a,openai:d,anthropic:p}[f],S=_({baseUrl:l.baseUrl||void 0,apiKey:l.apiKey}),L=r.filter(v=>v.type.startsWith("image/")),P=r.filter(v=>v.type==="application/pdf"),C=ot();let E=rt(o,C);if(P.length>0){const v=await Promise.all(P.map(et));E+=`

${v.map((b,R)=>`<pdf_document_${R+1}>
${b}
</pdf_document_${R+1}>`).join(`

`)}`}if(e>1&&(s.info("System prompt:",t),s.info("User prompt with context:",E)),f==="openai"&&L.length>0){const v=await Promise.all(L.map(async b=>{const R=await b.arrayBuffer();return{data:new Uint8Array(R),mimeType:b.type}}));return u({model:S.chat(l.model),temperature:i.temperature,system:t||void 0,messages:[{role:"user",content:[{type:"text",text:E},...v.map(b=>({type:"image",image:b.data}))]}],abortSignal:n})}return u({model:S.chat(l.model),temperature:i.temperature,system:t||void 0,prompt:E,abortSignal:n})}function at(o,t,r,e){let n;const s=()=>{n==null||n(),n=void 0},i=(d,u,f,l)=>(d.addEventListener(u,f,l),()=>d.removeEventListener(u,f,l)),p=V(()=>ct(o),d=>{s(),d&&(n=i(d,t,r,e))},{immediate:!0,flush:"post"}),a=()=>{p(),s()};return Ie()&&Re(a),a}function ct(o){const t=ee(o);return(t==null?void 0:t.$el)??t}let B;async function lt({accept:o="*",multiple:t=!0}={}){return B=document.createElement("input"),B.type="file",B.classList.add("sr-only"),B.value=null,B.accept=o,B.multiple=t,B.click(),new Promise(r=>{B.addEventListener("change",e=>{r([...e.target.files]),B.remove()})})}async function ut(o,t){const r=await pt(o);return await dt(r,o.type,t)}async function pt(o,t={}){if(!o.type.startsWith("image/"))throw new TypeError(`MIME type must be an image, but got: ${o.type}`);const r=new Image,e=URL.createObjectURL(o);t.crossOrigin&&(r.crossOrigin=t.crossOrigin);try{return await new Promise((s,i)=>{r.addEventListener("load",()=>{s(r)}),r.addEventListener("error",i),r.src=e})}finally{URL.revokeObjectURL(e)}}async function dt(o,t,r){if(!o.complete||!o.naturalWidth)throw new Error("Image has not been properly loaded");if(!t.startsWith("image/"))throw new Error(`Blob type must be an image, but got: ${t}`);const e=document.createElement("canvas"),n=e.getContext("2d"),s=Math.min(1,r/Math.max(o.width,o.height)),i=Math.round(o.width*s),p=Math.round(o.height*s);e.width=i,e.height=p,n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high",n.drawImage(o,0,0,i,p);const a=await new Promise(d=>{e.toBlob(d,t)});if(!a)throw new Error("Failed to convert canvas to Blob");return a}async function ge(){const o=await lt({accept:[...ne,"application/pdf"].join(",")});return await Promise.all(o.map(async t=>t.type.startsWith("image/")?ut(t,2048):t))}const ve=Object.freeze({ignoreUnknown:!1,respectType:!1,respectFunctionNames:!1,respectFunctionProperties:!1,unorderedObjects:!0,unorderedArrays:!1,unorderedSets:!1,excludeKeys:void 0,excludeValues:void 0,replacer:void 0});function ft(o,t){t?t={...ve,...t}:t=ve;const r=ye(t);return r.dispatch(o),r.toString()}const mt=Object.freeze(["prototype","__proto__","constructor"]);function ye(o){let t="",r=new Map;const e=n=>{t+=n};return{toString(){return t},getContext(){return r},dispatch(n){return o.replacer&&(n=o.replacer(n)),this[n===null?"null":typeof n](n)},object(n){if(n&&typeof n.toJSON=="function")return this.object(n.toJSON());const s=Object.prototype.toString.call(n);let i="";const p=s.length;p<10?i="unknown:["+s+"]":i=s.slice(8,p-1),i=i.toLowerCase();let a=null;if((a=r.get(n))===void 0)r.set(n,r.size);else return this.dispatch("[CIRCULAR:"+a+"]");if(typeof Buffer<"u"&&Buffer.isBuffer&&Buffer.isBuffer(n))return e("buffer:"),e(n.toString("utf8"));if(i!=="object"&&i!=="function"&&i!=="asyncfunction")this[i]?this[i](n):o.ignoreUnknown||this.unkown(n,i);else{let d=Object.keys(n);o.unorderedObjects&&(d=d.sort());let u=[];o.respectType!==!1&&!be(n)&&(u=mt),o.excludeKeys&&(d=d.filter(l=>!o.excludeKeys(l)),u=u.filter(l=>!o.excludeKeys(l))),e("object:"+(d.length+u.length)+":");const f=l=>{this.dispatch(l),e(":"),o.excludeValues||this.dispatch(n[l]),e(",")};for(const l of d)f(l);for(const l of u)f(l)}},array(n,s){if(s=s===void 0?o.unorderedArrays!==!1:s,e("array:"+n.length+":"),!s||n.length<=1){for(const a of n)this.dispatch(a);return}const i=new Map,p=n.map(a=>{const d=ye(o);d.dispatch(a);for(const[u,f]of d.getContext())i.set(u,f);return d.toString()});return r=i,p.sort(),this.array(p,!1)},date(n){return e("date:"+n.toJSON())},symbol(n){return e("symbol:"+n.toString())},unkown(n,s){if(e(s),!!n&&(e(":"),n&&typeof n.entries=="function"))return this.array(Array.from(n.entries()),!0)},error(n){return e("error:"+n.toString())},boolean(n){return e("bool:"+n)},string(n){e("string:"+n.length+":"),e(n)},function(n){e("fn:"),be(n)?this.dispatch("[native]"):this.dispatch(n.toString()),o.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(n.name)),o.respectFunctionProperties&&this.object(n)},number(n){return e("number:"+n)},xml(n){return e("xml:"+n.toString())},null(){return e("Null")},undefined(){return e("Undefined")},regexp(n){return e("regex:"+n.toString())},uint8array(n){return e("uint8array:"),this.dispatch(Array.prototype.slice.call(n))},uint8clampedarray(n){return e("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(n))},int8array(n){return e("int8array:"),this.dispatch(Array.prototype.slice.call(n))},uint16array(n){return e("uint16array:"),this.dispatch(Array.prototype.slice.call(n))},int16array(n){return e("int16array:"),this.dispatch(Array.prototype.slice.call(n))},uint32array(n){return e("uint32array:"),this.dispatch(Array.prototype.slice.call(n))},int32array(n){return e("int32array:"),this.dispatch(Array.prototype.slice.call(n))},float32array(n){return e("float32array:"),this.dispatch(Array.prototype.slice.call(n))},float64array(n){return e("float64array:"),this.dispatch(Array.prototype.slice.call(n))},arraybuffer(n){return e("arraybuffer:"),this.dispatch(new Uint8Array(n))},url(n){return e("url:"+n.toString())},map(n){e("map:");const s=[...n];return this.array(s,o.unorderedSets!==!1)},set(n){e("set:");const s=[...n];return this.array(s,o.unorderedSets!==!1)},file(n){return e("file:"),this.dispatch([n.name,n.size,n.type,n.lastModfied])},blob(){if(o.ignoreUnknown)return e("[blob]");throw new Error(`Hashing Blob objects is currently not supported
Use "options.replacer" or "options.ignoreUnknown"
`)},domwindow(){return e("domwindow")},bigint(n){return e("bigint:"+n.toString())},process(){return e("process")},timer(){return e("timer")},pipe(){return e("pipe")},tcp(){return e("tcp")},udp(){return e("udp")},tty(){return e("tty")},statwatcher(){return e("statwatcher")},securecontext(){return e("securecontext")},connection(){return e("connection")},zlib(){return e("zlib")},context(){return e("context")},nodescript(){return e("nodescript")},httpparser(){return e("httpparser")},dataview(){return e("dataview")},signal(){return e("signal")},fsevent(){return e("fsevent")},tlswrap(){return e("tlswrap")}}}const _e="[native code] }",ht=_e.length;function be(o){return typeof o!="function"?!1:Function.prototype.toString.call(o).slice(-ht)===_e}var gt=Object.defineProperty,vt=(o,t,r)=>t in o?gt(o,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[t]=r,O=(o,t,r)=>(vt(o,typeof t!="symbol"?t+"":t,r),r);class z{constructor(t,r){O(this,"words"),O(this,"sigBytes"),t=this.words=t||[],this.sigBytes=r===void 0?t.length*4:r}toString(t){return(t||yt).stringify(this)}concat(t){if(this.clamp(),this.sigBytes%4)for(let r=0;r<t.sigBytes;r++){const e=t.words[r>>>2]>>>24-r%4*8&255;this.words[this.sigBytes+r>>>2]|=e<<24-(this.sigBytes+r)%4*8}else for(let r=0;r<t.sigBytes;r+=4)this.words[this.sigBytes+r>>>2]=t.words[r>>>2];return this.sigBytes+=t.sigBytes,this}clamp(){this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4)}clone(){return new z([...this.words])}}const yt={stringify(o){const t=[];for(let r=0;r<o.sigBytes;r++){const e=o.words[r>>>2]>>>24-r%4*8&255;t.push((e>>>4).toString(16),(e&15).toString(16))}return t.join("")}},_t={stringify(o){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=[];for(let e=0;e<o.sigBytes;e+=3){const n=o.words[e>>>2]>>>24-e%4*8&255,s=o.words[e+1>>>2]>>>24-(e+1)%4*8&255,i=o.words[e+2>>>2]>>>24-(e+2)%4*8&255,p=n<<16|s<<8|i;for(let a=0;a<4&&e*8+a*6<o.sigBytes*8;a++)r.push(t.charAt(p>>>6*(3-a)&63))}return r.join("")}},bt={parse(o){const t=o.length,r=[];for(let e=0;e<t;e++)r[e>>>2]|=(o.charCodeAt(e)&255)<<24-e%4*8;return new z(r,t)}},wt={parse(o){return bt.parse(unescape(encodeURIComponent(o)))}};class kt{constructor(){O(this,"_data",new z),O(this,"_nDataBytes",0),O(this,"_minBufferSize",0),O(this,"blockSize",512/32)}reset(){this._data=new z,this._nDataBytes=0}_append(t){typeof t=="string"&&(t=wt.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes}_doProcessBlock(t,r){}_process(t){let r,e=this._data.sigBytes/(this.blockSize*4);t?e=Math.ceil(e):e=Math.max((e|0)-this._minBufferSize,0);const n=e*this.blockSize,s=Math.min(n*4,this._data.sigBytes);if(n){for(let i=0;i<n;i+=this.blockSize)this._doProcessBlock(this._data.words,i);r=this._data.words.splice(0,n),this._data.sigBytes-=s}return new z(r,s)}}class xt extends kt{update(t){return this._append(t),this._process(),this}finalize(t){t&&this._append(t)}}var St=Object.defineProperty,Pt=(o,t,r)=>t in o?St(o,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):o[t]=r,Ct=(o,t,r)=>(Pt(o,t+"",r),r);const we=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],Bt=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],M=[];class Lt extends xt{constructor(){super(...arguments),Ct(this,"_hash",new z([...we]))}reset(){super.reset(),this._hash=new z([...we])}_doProcessBlock(t,r){const e=this._hash.words;let n=e[0],s=e[1],i=e[2],p=e[3],a=e[4],d=e[5],u=e[6],f=e[7];for(let l=0;l<64;l++){if(l<16)M[l]=t[r+l]|0;else{const w=M[l-15],$=(w<<25|w>>>7)^(w<<14|w>>>18)^w>>>3,v=M[l-2],b=(v<<15|v>>>17)^(v<<13|v>>>19)^v>>>10;M[l]=$+M[l-7]+b+M[l-16]}const _=a&d^~a&u,S=n&s^n&i^s&i,L=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),P=(a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25),C=f+P+_+Bt[l]+M[l],E=L+S;f=u,u=d,d=a,a=p+C|0,p=i,i=s,s=n,n=C+E|0}e[0]=e[0]+n|0,e[1]=e[1]+s|0,e[2]=e[2]+i|0,e[3]=e[3]+p|0,e[4]=e[4]+a|0,e[5]=e[5]+d|0,e[6]=e[6]+u|0,e[7]=e[7]+f|0}finalize(t){super.finalize(t);const r=this._nDataBytes*8,e=this._data.sigBytes*8;return this._data.words[e>>>5]|=128<<24-e%32,this._data.words[(e+64>>>9<<4)+14]=Math.floor(r/4294967296),this._data.words[(e+64>>>9<<4)+15]=r,this._data.sigBytes=this._data.words.length*4,this._process(),this._hash}}function Et(o){return new Lt().finalize(o).toString(_t)}function $t(o,t={}){const r=typeof o=="string"?o:ft(o,t);return Et(r).slice(0,10)}function zt(...o){return`${Ze}${$t([...o])}`}const ke={...Ye},jt=Object.assign({inheritAttrs:!1},{__name:"Copilot",props:ke,setup(o){const t=o,r=Q(),e=y(),n=A(),{currentContent:s,update:i}=le(),p=/^<(\w+)>\s*<\/\1>$/,a={blocks:"HTML",writer:"HTML",textarea:"markdown",markdown:"markdown"},d=m(),u=m(),f=m(),l=m(),_=m(),S=m(),L=m(),P=m(),C=m(),E=m(),w=m(),$=m(!1),v=m(!1),b=m(!1),R=m(!1),oe=m(),K=m(),k=m(),ie=m([]),H=m([]),Se=m();let j,T;const Pe=I(()=>!v.value&&k.value!==void 0);V(K,h=>{$.value&&_.value&&(h&&h!==f.value?localStorage.setItem(`${j}$prompt`,h):(!h||h===f.value)&&localStorage.removeItem(`${j}$prompt`))}),V(b,h=>{$.value&&_.value&&(h?localStorage.setItem(`${j}$open`,"true"):localStorage.removeItem(`${j}$open`))}),(async()=>{const{load:h}=Ee(),[x,g]=await Promise.all([re(),h({parent:t.parent,name:t.name})]);if(d.value=Ce(g.label)||e.t("johannschopplich.copilot.label"),u.value=g.field??void 0,f.value=g.userPrompt??void 0,l.value=g.systemPrompt||x.config.systemPrompt||me,_.value=g.storage,g.editable===!0&&ie.value.push("edit"),g.files===!0&&ie.value.push("files"),S.value=g.theme||"notice-icon",L.value=g.size||"md",P.value=Qe.indexOf(x.config.logLevel??g.logLevel),C.value=g.fieldType,w.value=x.config,Se.value=x.licenseStatus,g.files==="auto"&&g.modelFile){E.value=g.modelFile;const{mime:N,url:Y}=g.modelFile;ne.includes(N)&&fetch(Y).then(ce=>ce.blob()).then(ce=>{H.value=[ce]})}_.value&&(j=zt(e.view.path,u.value),K.value=localStorage.getItem(`${j}$prompt`)||f.value||"",b.value=localStorage.getItem(`${j}$open`)==="true",Fe(()=>{oe.value&&b.value&&(oe.value.open=!0)})),e.events.on("view.save",ae),$.value=!0})(),Me(()=>{e.events.off("view.save",ae)});function Ce(h){return!h||typeof h=="string"?h:h[e.translation.code]??Object.values(h)[0]}async function Qt(){if(!K.value){e.notification.error(e.t("johannschopplich.copilot.prompt.empty"));return}e.isLoading=!0,v.value=!0,k.value=s.value[u.value],T=new AbortController;let h="",x=Date.now();try{const{textStream:g}=await he({userPrompt:[K.value,`<response_format>
${Be(C.value)}
</response_format>`].join(`

`),systemPrompt:l.value,files:H.value,logLevel:P.value,abortSignal:T.signal});for await(const N of g)if(h+=N,Array.isArray(k.value)){if(Date.now()-x<w.value.blocksUpdateThrottle)continue;x=Date.now();const Y=await se(h);Y.length>0&&await i({[u.value]:[...k.value,...Y]},!1)}else await i({[u.value]:k.value+h},!1)}catch(g){if(T=void 0,e.isLoading=!1,v.value=!1,g instanceof Error&&g.name==="AbortError")return;const{AISDKError:N}=await G("ai");if(N.isInstance(g)){console.error(g),e.notification.error(g.message);return}console.error(g),e.notification.error(e.t("johannschopplich.copilot.generator.error"));return}i({[u.value]:Array.isArray(k.value)?[...k.value,...await se(h)]:k.value+h}),T=void 0,e.isLoading=!1,v.value=!1,e.notification.success({icon:"sparkling",message:e.t("johannschopplich.copilot.generator.success")})}function Zt(){T==null||T.abort()}function en(){i({[u.value]:k.value}),k.value=void 0}async function tn(){const h=await ge();H.value=[...H.value,...h]}async function se(h){if(!h)return[];const{blocks:x}=await n.post("__copilot__/html2blocks",{html:h});return x.length===1&&"text"in x[0].content&&p.test(x[0].content.text)?[]:x}function ae(){Pe.value&&(k.value=void 0)}function Be(h){return a[h]||"text"}return{__sfc:!0,propsDefinition:ke,props:t,_isKirby5:r,panel:e,api:n,currentContent:s,updateContent:i,EMPTY_HTML_TAG_RE:p,RESPONSE_FORMAT_PER_FIELD:a,label:d,field:u,userPrompt:f,systemPrompt:l,storage:_,theme:S,size:L,logLevel:P,fieldType:C,modelFile:E,config:w,isInitialized:$,isGenerating:v,isDetailsOpen:b,isBadgeHovered:R,detailsElement:oe,currentPrompt:K,currentFieldContent:k,allow:ie,files:H,licenseStatus:Se,storageKey:j,abortController:T,canUndo:Pe,t:Ce,generate:Qt,abort:Zt,undo:en,pickFiles:tn,htmlToBlocks:se,onModelSave:ae,fieldTypeToResponseFormat:Be,LicensingButtonGroup:de,SUPPORTED_PROVIDERS:fe,SUPPORTED_VISION_MIME_TYPES:ne}}});var Tt=function(){var n,s,i,p;var t=this,r=t._self._c,e=t._self._setupProxy;return e.isInitialized?r("k-section",{attrs:{label:e.label}},[e.licenseStatus!==void 0?r("template",{slot:"options"},[r(e.LicensingButtonGroup,{attrs:{label:"Kirby Copilot","api-namespace":"__copilot__","license-status":e.licenseStatus,"pricing-url":"https://kirbycopilot.com/buy"}})],1):t._e(),!e.config.provider||!e.SUPPORTED_PROVIDERS.includes(e.config.provider)?r("k-box",{attrs:{theme:"empty"}},[r("k-text",[t._v(" Unsupported provider "),r("code",[t._v(t._s(e.config.provider))]),t._v(" in the "),r("code",[t._v("johannschopplich.copilot.provider")]),t._v(" global configuration. ")])],1):(s=(n=e.config.providers)==null?void 0:n[e.config.provider])!=null&&s.apiKey?(p=(i=e.config.providers)==null?void 0:i[e.config.provider])!=null&&p.model?e.field?e.field in e.currentContent?!e.allow.includes("edit")&&!e.userPrompt?r("k-box",{attrs:{theme:"empty"}},[r("k-text",[t._v(" If the user prompt cannot be edited by the user, a default "),r("code",[t._v("userPrompt")]),t._v(" has to be set in the section configuration. ")])],1):r("div",{staticClass:"kai-space-y-4"},[r("k-button-group",{attrs:{layout:"collapsed"}},[r("k-button",{attrs:{icon:e.isGenerating?"loader":"sparkling",text:e.panel.t("johannschopplich.copilot.generate"),theme:e.theme,variant:"filled",size:e.size,disabled:e.isGenerating},on:{click:function(a){return e.generate()}}}),e.isGenerating?r("k-button",{attrs:{icon:"cancel",text:e.panel.t("johannschopplich.copilot.stop"),theme:"notice",variant:"filled",size:e.size},on:{click:function(a){return e.abort()}}}):t._e(),e.canUndo?r("k-button",{attrs:{icon:"undo",text:e.panel.t("johannschopplich.copilot.undo"),variant:"filled",size:e.size},on:{click:function(a){return e.undo()}}}):t._e()],1),e.allow.length>0?r("details",{ref:"detailsElement",on:{toggle:function(a){e.isDetailsOpen=a.target.open}}},[r("summary",[t._v(" "+t._s([...e.allow.includes("edit")?[e.panel.t("johannschopplich.copilot.prompt.label")]:[],...e.allow.includes("files")?[e.panel.t("johannschopplich.copilot.context")]:[]].join(", "))+" ")]),r("div",{staticClass:"kai-mt-3"},[e.allow.includes("edit")?r("div",{staticClass:"kai-mb-2 kai-text-right"},[r("k-input",{key:e.isDetailsOpen?1:0,staticClass:"kai-mb-1",attrs:{value:e.currentPrompt,placeholder:e.panel.t("johannschopplich.copilot.prompt.placeholder"),type:"textarea",buttons:!1,counter:!1},on:{input:function(a){e.currentPrompt=a}}}),r("k-button",{directives:[{name:"show",rawName:"v-show",value:e.userPrompt&&e.currentPrompt!==e.userPrompt,expression:"userPrompt && currentPrompt !== userPrompt"}],attrs:{icon:"undo",text:"Reset",variant:"dimmed",size:"xs"},on:{click:function(a){e.currentPrompt=e.userPrompt}}})],1):t._e(),e.allow.includes("files")?r("div",{staticClass:"kai-relative kai-w-max"},[r("k-button",{attrs:{icon:"attachment",text:e.panel.t("johannschopplich.copilot.files.select"),variant:"filled",size:"sm"},on:{click:function(a){return e.pickFiles()}}}),e.files.length>0?r("span",{staticClass:"kai-cursor-pointer",class:[e._isKirby5?"k-button-badge kai-top-[-2px]":"k-tabs-badge kai-top-[-6px]"],attrs:{"data-theme":e.isBadgeHovered?"negative":"notice"},on:{mouseenter:function(a){e.isBadgeHovered=!0},mouseleave:function(a){e.isBadgeHovered=!1},click:function(a){e.files=[],e.isBadgeHovered=!1}}},[t._v(" "+t._s(e.isBadgeHovered?e.panel.t("johannschopplich.copilot.delete"):e.files.length)+" ")]):t._e()],1):e.modelFile?r("k-box",{attrs:{theme:"none"}},[r("k-text",[t._v(" "+t._s(e.panel.t(`johannschopplich.copilot.context.file.${e.SUPPORTED_VISION_MIME_TYPES.includes(e.modelFile.mime)?"model":"unsupported"}`))+" ")])],1):t._e()],1)]):t._e()],1):r("k-box",{attrs:{theme:"empty"}},[r("k-text",[t._v(" The "),r("code",[t._v(t._s(e.field))]),t._v(" field does not exist in the current model. ")])],1):r("k-box",{attrs:{theme:"empty"}},[r("k-text",[t._v(" Missing "),r("code",[t._v("field")]),t._v(" property in the section configuration. It is required for the generated text. ")])],1):r("k-box",{attrs:{theme:"empty"}},[r("k-text",[t._v(" Missing "),r("code",[t._v("model")]),t._v(" property in the "),r("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1):r("k-box",{attrs:{theme:"empty"}},[r("k-text",[t._v(" Missing "),r("code",[t._v("apiKey")]),t._v(" property in the "),r("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1)],2):t._e()},At=[],It=W(jt,Tt,At,!1,null,null);const Ft=It.exports,Mt=Object.assign({inheritAttrs:!1},{__name:"AutoGrowTextarea",props:{value:{type:String,required:!0},sharedClass:{type:String,default:void 0}},emits:["input"],setup(o,{emit:t}){const r=o,e=m(r.value);return V(e,n=>{t("input",n)}),{__sfc:!0,props:r,emit:t,text:e}}});var Ot=function(){var t=this,r=t._self._c,e=t._self._setupProxy;return r("div",{staticClass:"kai-grid"},[r("textarea",t._b({directives:[{name:"model",rawName:"v-model",value:e.text,expression:"text"}],staticClass:"auto-grow-area kai-resize-none kai-overflow-hidden",class:t.sharedClass,domProps:{value:e.text},on:{input:function(n){n.target.composing||(e.text=n.target.value)}}},"textarea",t.$attrs,!1)),t._v(" "),r("div",{staticClass:"auto-grow-area kai-invisible kai-whitespace-pre-wrap",class:t.sharedClass,domProps:{textContent:t._s(`${t.value} `)}})])},Rt=[],Dt=W(Mt,Ot,Rt,!1,null,"994bf856");const Ut=Dt.exports,Kt={__name:"PromptDialog",props:{selection:{type:String,default:""}},emits:["cancel","close","input","submit","success"],setup(o,{emit:t}){const r=y(),e=Q(),n=m([]),s=m("append"),i=m(""),p=m(!1),a=m();at(document,"keydown",f=>{f.metaKey&&f.key==="Enter"&&d()}),(async()=>{const f=await re();a.value=f.licenseStatus})();function d(){t("submit",{prompt:i.value,files:n.value,append:s.value==="append"})}async function u(){const f=await ge();n.value=[...n.value,...f]}return{__sfc:!0,emit:t,panel:r,_isKirby5:e,files:n,insertOption:s,prompt:i,isBadgeHovered:p,licenseStatus:a,submit:d,pickFiles:u,LicensingButtonGroup:de,AutoGrowTextarea:Ut}}};var Ht=function(){var t=this,r=t._self._c,e=t._self._setupProxy;return r("k-dialog",{staticClass:"k-copilot-prompt-dialog",attrs:{"cancel-button":!1,"submit-button":!1,visible:!0,size:"medium"},on:{cancel:function(n){return e.emit("cancel")}}},[r("div",{staticClass:"kai-relative kai-rounded-[var(--rounded)] kai-pb-[calc(1rem+32px)] focus-within:kai-outline focus-within:kai-outline-[2px] focus-within:kai-outline-[var(--color-focus,currentColor)]"},[r(e.AutoGrowTextarea,{attrs:{value:e.prompt,"shared-class":"kai-p-2 kai-leading-[1.5] focus:kai-outline-none",placeholder:e.panel.t(t.selection?"johannschopplich.copilot.prompt.dialogContextPlaceholder":"johannschopplich.copilot.prompt.dialogPlaceholder")},on:{input:function(n){e.prompt=n}}}),r("div",{staticClass:"kai-absolute kai-inset-x-px kai-bottom-px kai-p-2"},[r("div",{staticClass:"kai-flex kai-items-center kai-justify-between"},[r("div",{staticClass:"kai-relative"},[r("k-button",{attrs:{theme:"empty",icon:"attachment"},on:{click:function(n){return e.pickFiles()}}}),e.files.length>0?r("span",{staticClass:"kai-cursor-pointer",class:[e._isKirby5?"k-button-badge kai-top-[-2px]":"k-tabs-badge kai-top-[-6px]"],attrs:{"data-theme":e.isBadgeHovered?"negative":"notice"},on:{mouseenter:function(n){e.isBadgeHovered=!0},mouseleave:function(n){e.isBadgeHovered=!1},click:function(n){e.files=[],e.isBadgeHovered=!1}}},[t._v(" "+t._s(e.isBadgeHovered?e.panel.t("johannschopplich.copilot.delete"):e.files.length)+" ")]):t._e()],1),r("div",{staticClass:"kai-flex kai-gap-2"},[t.selection?r("k-select-input",{staticClass:"k-copilot-prompt-dialog__select",attrs:{options:[{value:"append",text:e.panel.t("johannschopplich.copilot.append")},{value:"replace",text:e.panel.t("johannschopplich.copilot.replace")}],empty:!1,value:e.insertOption},on:{input:function(n){e.insertOption=n}}}):t._e(),r("k-button",{attrs:{theme:"notice-icon",variant:"filled",icon:"sparkling"},on:{click:function(n){return e.submit()}}},[t._v(" "+t._s(e.panel.t("johannschopplich.copilot.generate"))+" ")])],1)])]),e.licenseStatus!==void 0?r(e.LicensingButtonGroup,{staticClass:"kai-absolute kai-right-0 kai-top-[calc(-0.25rem-24px)]",attrs:{label:"Kirby Copilot","api-namespace":"__copilot__","license-status":e.licenseStatus,"pricing-url":"https://kirbycopilot.com/buy"}}):t._e()],1)])},Nt=[],qt=W(Kt,Ht,Nt,!1,null,null);const Gt=qt.exports,Vt={};async function xe(o,{appendText:t,replaceText:r,responseFormat:e="text"}){const n=y(),s=new AbortController,i=u=>{u.key==="Escape"&&s.abort()},p=await Wt({selection:o});if(!p)return;const{prompt:a,files:d}=p;if(a){n.isLoading=!0,document.addEventListener("keydown",i);try{const{textStream:u}=await he({userPrompt:[a,`<response_format>
${e}
</response_format>`,o&&`<selected_text>
${o}
</selected_text>`].filter(Boolean).join(`

`),systemPrompt:me,files:d,abortSignal:s.signal});let f=!0;for await(let l of u)p.append?(f&&(l=o?` ${l}`:l,f=!1),t(l)):r(l);n.notification.success({icon:"sparkling",message:n.t("johannschopplich.copilot.generator.success")})}catch(u){if(u instanceof Error&&(u.name==="AbortError"||u.name==="TimeoutError"))return;const{AISDKError:f}=await G("ai");if(f.isInstance(u)){console.error(u),n.notification.error(u.message);return}console.error(u),n.notification.error(n.t("johannschopplich.copilot.generator.error"))}finally{n.isLoading=!1,document.removeEventListener("keydown",i)}}}async function Wt(o={}){return new Promise(t=>{const r=y();let e;r.dialog.open({component:"k-copilot-prompt-dialog",props:o,on:{close:()=>{t(e)},submit:n=>{e=n,r.dialog.close()}}})})}const Jt={copilot:{icon:"sparkling",label:"Copilot Prompt",click(){let o="";this.command("insert",(n,s)=>(o=s,s));let t=!0;xe(o,{responseFormat:"markdown",appendText:n=>{this.command("insert",(s,i)=>t?(t=!1,i+n):n)},replaceText:n=>{this.command("insert",()=>n)}})},shortcut:"."}},Yt={copilot:{get button(){return{icon:"sparkling",label:"Copilot Prompt"}},commands(o){return()=>this._openPromptDialog(o)},keys(o){return{"Mod-.":()=>this._openPromptDialog(o)}},get name(){return"copilot"},_insertText(o,t,r,{schema:e}){let n=r;const s=t.split(/(\n\n?)/);for(const i of s)i===`

`?(o=o.replaceWith(n,n,this.editor.options.inline?[e.nodes.hardBreak.create(),e.nodes.hardBreak.create()]:e.nodes.paragraph.create()),n+=2):i===`
`?(o=o.replaceWith(n,n,e.nodes.hardBreak.create()),n+=1):i.length>0&&(o=o.insertText(i,n),n+=i.length);return{tr:o,newPosition:n}},_openPromptDialog(o){const{state:t}=this.editor,{from:r,to:e}=t.tr.selection,n=t.doc.textBetween(r,e);let s=e,i=!1;xe(n,{responseFormat:"text",replaceText:d=>{const{state:u,view:f}=this.editor;let l=u.tr;if(!i){const L=Xt(u),{from:P,to:C}=l.selection;l=l.deleteRange(P,C),s=L?1:P,i=!0}const{tr:_,newPosition:S}=this._insertText(l,d,s,o);s=S,f.dispatch(_)},appendText:d=>{const{state:u,view:f}=this.editor,l=u.tr,{tr:_,newPosition:S}=this._insertText(l,d,s,o);s=S,f.dispatch(_)}})}}};function Xt(o){const t=o.doc.content.size,{from:r,to:e}=o.selection;return r===0&&e===t}window.panel.plugin("johannschopplich/copilot",{components:{"k-copilot-prompt-dialog":Gt},sections:{copilot:Ft},fields:{},icons:Vt,textareaButtons:Jt,writerMarks:Yt})})();
