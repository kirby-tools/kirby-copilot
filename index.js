var cn=Object.defineProperty;var ln=(l,w,j)=>w in l?cn(l,w,{enumerable:!0,configurable:!0,writable:!0,value:j}):l[w]=j;var X=(l,w,j)=>ln(l,typeof w!="symbol"?w+"":w,j);(function(){"use strict";const l=window.Vue;function w(){return window.panel}function j(){return w().api}const Q=()=>window.panel.plugins.viewButtons!==void 0;function ze(){const r=w().app.$store;return r||new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}})}function ue(){const r=w(),t=ze(),n=Q(),e=A(n?()=>r.view.props.content:()=>t.getters["content/values"]()),o=A(n?()=>r.content.changes():()=>t.getters["content/changes"]()),i=A(n?()=>Object.keys(o.value).length>0:()=>t.getters["content/hasChanges"]()),s=n?r.content:new Proxy({},{get(){return()=>{}}});return{content:s,currentContent:e,contentChanges:o,hasChanges:i,update:async(a,f=!0)=>{if(!n&&a)for(const[p,u]of Object.entries(a))t.dispatch("content/update",[p,u]);const d=s.merge(a);f&&await s.save(d)}}}function je(){const r=j();return{load:({parent:n,name:e})=>r.get(`${n}/sections/${e}`)}}const Ie={error:0,warn:1,log:2,info:3,success:3};function Fe(r){const t=new Oe;return new Proxy({},{get(n,e){return(...o)=>{t.log({level:Ie[e],type:e,tag:r,args:o})}}})}class Oe{constructor(){X(this,"defaultColor","#7f8c8d");X(this,"levelColorMap",{0:"#c0392b",1:"#f39c12",3:"#00BCD4"});X(this,"typeColorMap",{success:"#2ecc71"})}log(t){const n=Re(t.level),e=t.type==="log"?"":t.type,o=t.tag||"",s=`
background: ${this.typeColorMap[t.type]||this.levelColorMap[t.level]||this.defaultColor};
border-radius: 0.5em;
color: white;
font-weight: bold;
padding: 2px 0.5em;
`.trimStart(),c=`%c${[o,e].filter(Boolean).join(":")}`;typeof t.args[0]=="string"?n(`${c}%c ${t.args[0]}`,s,"",...t.args.slice(1)):n(c,s,...t.args)}}function Re(r){return r<1?console.error:console.log}const q=[],Z=new Map;async function De(r){if(!Array.isArray(r))throw new TypeError(`Expected an array, got ${typeof r}`);for(const t of r)q.some(n=>n.filename===t.filename)||q.push(t)}function pe(r){if(q.length===0)throw new Error("Plugin assets not registered");const t=q.find(n=>n.filename===r);if(!t)throw new Error(`Plugin asset "${r}" not found`);return t}async function G(r){if(r.endsWith(".js")||(r+=".js"),Z.has(r))return Z.get(r);const n=await import(pe(r).url);return Z.set(r,n),n}const A=l.computed;l.customRef,l.defineAsyncComponent,l.defineComponent,l.effectScope,l.getCurrentInstance;const Ue=l.getCurrentScope;l.h,l.inject,l.isProxy,l.isReactive,l.isReadonly,l.isRef,l.isShallow,l.markRaw;const He=l.nextTick;l.onActivated,l.onBeforeMount;const Ke=l.onBeforeUnmount;l.onBeforeUpdate,l.onDeactivated,l.onErrorCaptured;const de=l.onMounted;l.onRenderTracked,l.onRenderTriggered;const Ne=l.onScopeDispose;l.onServerPrefetch,l.onUnmounted,l.onUpdated,l.provide,l.proxyRefs,l.reactive,l.readonly;const m=l.ref;l.shallowReactive,l.shallowReadonly,l.shallowRef,l.toRaw,l.toRef,l.toRefs,l.triggerRef;const ee=l.unref;l.useAttrs,l.useCssModule,l.useCssVars,l.useListeners,l.useSlots;const te=l.watch;l.watchEffect,l.watchPostEffect,l.watchSyncEffect;const ne={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Find your order number</a> on Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.unauthorized":"Email address or order ID is incorrect","modal.error.invalid.licenseKey":"License key invalid for this plugin","modal.error.incompatible":"License key invalid for this plugin version","modal.error.upgradeable":"License key invalid for this plugin version. Upgrade now on https://hub.kirby.tools.","modal.error.activated":"License key already activated",activate:"Activate",activated:"Plugin activated",buy:"Buy a license",upgrade:"Upgrade"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Finde deine Bestellnummer</a> bei Lemon Squeezy oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.unauthorized":"E-Mail-Adresse oder Bestellnummer ist falsch","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin","modal.error.incompatible":"Lizenzschlüssel ungültig für diese Plugin-Version","modal.error.upgradeable":"Lizenzschlüssel ungültig für diese Plugin-Version. Aktualisiere jetzt auf https://hub.kirby.tools.","modal.error.activated":"Lizenzschlüssel bereits aktiviert",activate:"Aktivieren",activated:"Plugin aktiviert",buy:"Lizenz kaufen",upgrade:"Upgrade"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Trouvez votre numéro de commande</a> sur Lemon Squeezy ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.unauthorized":"Adresse e-mail ou numéro de commande incorrect","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin","modal.error.incompatible":"Clé de licence invalide pour cette version du plugin","modal.error.upgradeable":"Clé de licence invalide pour cette version du plugin. Mettez à niveau maintenant sur https://hub.kirby.tools.","modal.error.activated":"Clé de licence déjà activée",activate:"Activer",activated:"Plugin activé",buy:"Acheter une licence",upgrade:"Upgrade"},nl:{"modal.info":"Bedankt voor het kopen van {label}! Voer je e-mailadres en bestelnummer in om je licentie te activeren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Vind je bestelnummer</a> op Lemon Squeezy of <a href="mailto:hello@kirby.tools">neem contact met ons op</a> als je het niet kunt vinden.',"modal.error.required.fields":"E-mailadres en bestelnummer zijn verplicht","modal.error.invalid.unauthorized":"E-mailadres of bestelnummer is onjuist","modal.error.invalid.licenseKey":"Licentiesleutel ongeldig voor dit plug-in","modal.error.incompatible":"Licentiesleutel ongeldig voor deze plug-inversie","modal.error.upgradeable":"Licentiesleutel ongeldig voor deze plug-inversie. Upgrade nu op https://hub.kirby.tools.","modal.error.activated":"Licentiesleutel al geactiveerd",activate:"Activeren",activated:"Plugin geactiveerd",buy:"Koop een licentie",upgrade:"Upgrade"}},qe=["localhost","127.0.0.1","[::1]"],Ge=["local","test","ddev.site"];function I(r="",t){var o;const n=window.panel.translation.code,e=((o=ne==null?void 0:ne[n])==null?void 0:o[r])??r;return t?We(e,t):e}function We(r,t,n){return r.replace(/\{(\w+)\}/g,(e,o)=>t[o]||o)}function Ve(){const{hostname:r}=window.location,t=qe.includes(r),n=Ge.some(e=>r.endsWith(`.${e}`));return t||n}const fe={Unauthorized:"modal.error.invalid.unauthorized","License key not valid for this plugin":"modal.error.invalid.licenseKey","License key not valid for this plugin version":"modal.error.incompatible","License key not valid for this plugin version, please upgrade your license":"modal.error.upgradeable","License key already activated":"modal.error.activated"};function Ye(r){const t=w();return{isLocalhost:Ve(),assertActivationIntegrity:async({component:i,licenseStatus:s})=>{if(ee(s)==="active")return;const c=ee(i);if(!(c!=null&&c.$el)||window.getComputedStyle(c.$el).display==="none"||window.getComputedStyle(c.$el).visibility==="hidden"||window.getComputedStyle(c.$el).opacity==="0")throw new Error("Are you trying to hide the activation buttons? Please buy a license.")},openLicenseModal:()=>{let i=!1;const{label:s}=r,c={info:{type:"info",text:I("modal.info",{label:s})},email:{label:t.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:I("modal.fields.orderId.help",{label:s})}};return new Promise(a=>{t.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:I("activate",{label:s})},fields:c},on:{close:()=>{a({isLicenseActive:i})},submit:async f=>{i=await Je(f,r),i&&(t.dialog.close(),t.notification.success(I("activated")))}}})})}}}async function Je(r,t){const n=w(),{email:e,orderId:o}=r;if(!e||!o)return n.notification.error(I("modal.error.required.fields")),!1;try{const i=await n.api.post(`${t.apiNamespace}/activate`,{email:e,orderId:Number(o)});if((i==null?void 0:i.status)!=="ok")throw new Error("Failed to activate license key");return!0}catch(i){const s=i.message;return n.notification.error(fe[s]?I(fe[s]):s),!1}}const Xe=Vue.defineComponent({__name:"LicensingButtonGroup",props:{label:{type:String,required:!0},apiNamespace:{type:String,required:!0},licenseStatus:{type:String,required:!0},pricingUrl:{type:String,required:!0}},setup(r){const t=r,{openLicenseModal:n,assertActivationIntegrity:e}=Ye({label:t.label,apiNamespace:t.apiNamespace}),o=m(t.licenseStatus),i=m();de(()=>{e({component:i,licenseStatus:t.licenseStatus})});async function s(){const{isLicenseActive:c}=await n();c&&window.location.reload()}return{__sfc:!0,props:t,openLicenseModal:n,assertActivationIntegrity:e,currentLicenseStatus:o,licenseButtonGroup:i,handleRegistration:s,t:I}}});function W(r,t,n,e,o,i,s,c){var a=typeof r=="function"?r.options:r;return t&&(a.render=t,a.staticRenderFns=n,a._compiled=!0),i&&(a._scopeId="data-v-"+i),{exports:r,options:a}}var Qe=function(){var t=this,n=t._self._c,e=t._self._setupProxy;return e.currentLicenseStatus!=="active"?n("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:e.currentLicenseStatus==="upgradeable"?"https://hub.kirby.tools":t.pricingUrl,target:"_blank",text:e.currentLicenseStatus==="upgradeable"?e.t("upgrade"):e.t("buy")}}),n("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.t("activate")},on:{click:function(o){return e.handleRegistration()}}})],1):t._e()},Ze=[],et=W(Xe,Qe,Ze,!1,null,null);const me=et.exports,tt={blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number},nt="__copilot__/context",he=["anthropic","mistral","openai"],oe=["image/png","image/jpeg","image/webp","image/gif"],ot=["error","warn","info","debug"],ge="kirby$copilot$",ve=`
You are an AI assistant integrated into a Content Management System (CMS). Your primary task is to answer user questions accurately and helpfully.

Instructions:
- If selected_text is provided, consider the selected text as context for the user's question.
- If pdf_documents are provided, additional context from PDF documents have been processed and made available to you. Consider the information from these documents as applicable.

Output Format:
- If response_format is set to "text", format your response in plain text. Do not include any Markdown syntax.
- If response_format is set to "HTML", format your response using HTML syntax. Do not include any other parts of a full HTML document structure, except for the content of the <body> element. Structure your response using appropriate HTML tags. Use <h2> or <h3> tags for section headings.
- If response_format is set to "markdown", format your response using Markdown syntax. Do not use backticks or any other wrapping characters around your response.
`;class re extends Error{}let D;async function rt(r){const t=await st(),n=await r.arrayBuffer(),e=await t.getDocument({data:n,useSystemFonts:!0}).promise;return(await Promise.all(Array.from({length:e.numPages},(i,s)=>it(e,s+1)))).map(i=>i.replace(/\s+/g," ")).join(`
`)}async function it(r,t){return(await(await r.getPage(t)).getTextContent()).items.filter(o=>o.str!=null).map(o=>o.str).join(" ")}async function st(){if(D)return D;D=await G("pdfjs");const r=pe("pdfjs.worker.js");return D.GlobalWorkerOptions.workerSrc=r.url,D}function at(r,t,n){return r.replace(/\{\s*(\w+)\s*\}/g,(e,o)=>t[o.toLowerCase()]||o)}function ct(){const{currentContent:r}=ue(),t={...r.value,title:window.panel.view.title};return Object.fromEntries(Object.entries(t).map(([n,e])=>[n,Array.isArray(e)||typeof e=="object"&&e!==null?JSON.stringify(e):e]))}let lt;function ut(){return lt??(lt=Fe("copilot"))}let V,U;function Y(){return V||U||(U=window.panel.api.get(nt).then(r=>(De(r.assets),V=r,U=void 0,V)),U)}async function ye({userPrompt:r,systemPrompt:t,files:n=[],logLevel:e=1,abortSignal:o}){var S,$;const i=ut();let{config:s}=await Y();if(!s.provider||!he.includes(s.provider))throw new re(`Unsupported provider "${s.provider}" in the "johannschopplich.copilot.provider" global configuration.`);for(const _ of["apiKey","model"])if(!(($=(S=s.providers)==null?void 0:S[s.provider])!=null&&$[_]))throw new re(`Missing "${_}" property in the "johannschopplich.copilot.providers.${s.provider}" global configuration.`);const{createAnthropic:c,createMistral:a,createOpenAI:f,streamText:d}=await G("ai"),p=s.provider,u=s.providers[p],g={mistral:a,openai:f,anthropic:c}[p],b=g({baseUrl:u.baseUrl||void 0,apiKey:u.apiKey}),v=n.filter(_=>_.type.startsWith("image/")),k=n.filter(_=>_.type==="application/pdf"),B=ct();let L=at(r,B);if(k.length>0){const _=await Promise.all(k.map(rt));L+=`

${_.map((x,R)=>`<pdf_document_${R+1}>
${x}
</pdf_document_${R+1}>`).join(`

`)}`}if(e>1&&(i.info("System prompt:",t),i.info("User prompt with context:",L)),p==="openai"&&v.length>0){const _=await Promise.all(v.map(async x=>{const R=await x.arrayBuffer();return{data:new Uint8Array(R),mimeType:x.type}}));return d({model:b.chat(u.model),temperature:s.temperature,system:t||void 0,messages:[{role:"user",content:[{type:"text",text:L},..._.map(x=>({type:"image",image:x.data}))]}],abortSignal:o})}return d({model:b.chat(u.model),temperature:s.temperature,system:t||void 0,prompt:L,abortSignal:o})}function pt(r,t,n,e){let o;const i=()=>{o==null||o(),o=void 0},s=(f,d,p,u)=>(f.addEventListener(d,p,u),()=>f.removeEventListener(d,p,u)),c=te(()=>dt(r),f=>{i(),f&&(o=s(f,t,n,e))},{immediate:!0,flush:"post"}),a=()=>{c(),i()};return Ue()&&Ne(a),a}function dt(r){const t=ee(r);return(t==null?void 0:t.$el)??t}let E;async function ft({accept:r="*",multiple:t=!0}={}){return E=document.createElement("input"),E.type="file",E.classList.add("sr-only"),E.value=null,E.accept=r,E.multiple=t,E.click(),new Promise(n=>{E.addEventListener("change",e=>{n([...e.target.files]),E.remove()})})}async function mt(r,t){const n=await ht(r);return await gt(n,r.type,t)}async function ht(r,t={}){if(!r.type.startsWith("image/"))throw new TypeError(`MIME type must be an image, but got: ${r.type}`);const n=new Image,e=URL.createObjectURL(r);t.crossOrigin&&(n.crossOrigin=t.crossOrigin);try{return await new Promise((i,s)=>{n.addEventListener("load",()=>{i(n)}),n.addEventListener("error",s),n.src=e})}finally{URL.revokeObjectURL(e)}}async function gt(r,t,n){if(!r.complete||!r.naturalWidth)throw new Error("Image has not been properly loaded");if(!t.startsWith("image/"))throw new Error(`Blob type must be an image, but got: ${t}`);const e=document.createElement("canvas"),o=e.getContext("2d"),i=Math.min(1,n/Math.max(r.width,r.height)),s=Math.round(r.width*i),c=Math.round(r.height*i);e.width=s,e.height=c,o.imageSmoothingEnabled=!0,o.imageSmoothingQuality="high",o.drawImage(r,0,0,s,c);const a=await new Promise(f=>{e.toBlob(f,t)});if(!a)throw new Error("Failed to convert canvas to Blob");return a}async function _e(){const r=await ft({accept:[...oe,"application/pdf"].join(",")});return await Promise.all(r.map(async t=>t.type.startsWith("image/")?mt(t,2048):t))}const we=`${ge}promptHistory`,be=50;function vt(){const r=m("");let t=JSON.parse(localStorage.getItem(we)||"[]"),n=-1;function e(i){if(!i)return;const s=t.indexOf(i);s!==-1&&t.splice(s,1),t.unshift(i),t.length>be&&(t=t.slice(0,be)),localStorage.setItem(we,JSON.stringify(t)),n=-1}function o(i){if(i==="up"){if(n+1<t.length)return n++,t[n]}else if(i==="down"){if(n>0)return n--,t[n];if(n===0)return n=-1,r.value}}return{lastPrompt:r,addToHistory:e,navigateHistory:o}}const ke=Object.freeze({ignoreUnknown:!1,respectType:!1,respectFunctionNames:!1,respectFunctionProperties:!1,unorderedObjects:!0,unorderedArrays:!1,unorderedSets:!1,excludeKeys:void 0,excludeValues:void 0,replacer:void 0});function yt(r,t){t?t={...ke,...t}:t=ke;const n=xe(t);return n.dispatch(r),n.toString()}const _t=Object.freeze(["prototype","__proto__","constructor"]);function xe(r){let t="",n=new Map;const e=o=>{t+=o};return{toString(){return t},getContext(){return n},dispatch(o){return r.replacer&&(o=r.replacer(o)),this[o===null?"null":typeof o](o)},object(o){if(o&&typeof o.toJSON=="function")return this.object(o.toJSON());const i=Object.prototype.toString.call(o);let s="";const c=i.length;c<10?s="unknown:["+i+"]":s=i.slice(8,c-1),s=s.toLowerCase();let a=null;if((a=n.get(o))===void 0)n.set(o,n.size);else return this.dispatch("[CIRCULAR:"+a+"]");if(typeof Buffer<"u"&&Buffer.isBuffer&&Buffer.isBuffer(o))return e("buffer:"),e(o.toString("utf8"));if(s!=="object"&&s!=="function"&&s!=="asyncfunction")this[s]?this[s](o):r.ignoreUnknown||this.unkown(o,s);else{let f=Object.keys(o);r.unorderedObjects&&(f=f.sort());let d=[];r.respectType!==!1&&!Pe(o)&&(d=_t),r.excludeKeys&&(f=f.filter(u=>!r.excludeKeys(u)),d=d.filter(u=>!r.excludeKeys(u))),e("object:"+(f.length+d.length)+":");const p=u=>{this.dispatch(u),e(":"),r.excludeValues||this.dispatch(o[u]),e(",")};for(const u of f)p(u);for(const u of d)p(u)}},array(o,i){if(i=i===void 0?r.unorderedArrays!==!1:i,e("array:"+o.length+":"),!i||o.length<=1){for(const a of o)this.dispatch(a);return}const s=new Map,c=o.map(a=>{const f=xe(r);f.dispatch(a);for(const[d,p]of f.getContext())s.set(d,p);return f.toString()});return n=s,c.sort(),this.array(c,!1)},date(o){return e("date:"+o.toJSON())},symbol(o){return e("symbol:"+o.toString())},unkown(o,i){if(e(i),!!o&&(e(":"),o&&typeof o.entries=="function"))return this.array(Array.from(o.entries()),!0)},error(o){return e("error:"+o.toString())},boolean(o){return e("bool:"+o)},string(o){e("string:"+o.length+":"),e(o)},function(o){e("fn:"),Pe(o)?this.dispatch("[native]"):this.dispatch(o.toString()),r.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(o.name)),r.respectFunctionProperties&&this.object(o)},number(o){return e("number:"+o)},xml(o){return e("xml:"+o.toString())},null(){return e("Null")},undefined(){return e("Undefined")},regexp(o){return e("regex:"+o.toString())},uint8array(o){return e("uint8array:"),this.dispatch(Array.prototype.slice.call(o))},uint8clampedarray(o){return e("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(o))},int8array(o){return e("int8array:"),this.dispatch(Array.prototype.slice.call(o))},uint16array(o){return e("uint16array:"),this.dispatch(Array.prototype.slice.call(o))},int16array(o){return e("int16array:"),this.dispatch(Array.prototype.slice.call(o))},uint32array(o){return e("uint32array:"),this.dispatch(Array.prototype.slice.call(o))},int32array(o){return e("int32array:"),this.dispatch(Array.prototype.slice.call(o))},float32array(o){return e("float32array:"),this.dispatch(Array.prototype.slice.call(o))},float64array(o){return e("float64array:"),this.dispatch(Array.prototype.slice.call(o))},arraybuffer(o){return e("arraybuffer:"),this.dispatch(new Uint8Array(o))},url(o){return e("url:"+o.toString())},map(o){e("map:");const i=[...o];return this.array(i,r.unorderedSets!==!1)},set(o){e("set:");const i=[...o];return this.array(i,r.unorderedSets!==!1)},file(o){return e("file:"),this.dispatch([o.name,o.size,o.type,o.lastModfied])},blob(){if(r.ignoreUnknown)return e("[blob]");throw new Error(`Hashing Blob objects is currently not supported
Use "options.replacer" or "options.ignoreUnknown"
`)},domwindow(){return e("domwindow")},bigint(o){return e("bigint:"+o.toString())},process(){return e("process")},timer(){return e("timer")},pipe(){return e("pipe")},tcp(){return e("tcp")},udp(){return e("udp")},tty(){return e("tty")},statwatcher(){return e("statwatcher")},securecontext(){return e("securecontext")},connection(){return e("connection")},zlib(){return e("zlib")},context(){return e("context")},nodescript(){return e("nodescript")},httpparser(){return e("httpparser")},dataview(){return e("dataview")},signal(){return e("signal")},fsevent(){return e("fsevent")},tlswrap(){return e("tlswrap")}}}const Se="[native code] }",wt=Se.length;function Pe(r){return typeof r!="function"?!1:Function.prototype.toString.call(r).slice(-wt)===Se}var bt=Object.defineProperty,kt=(r,t,n)=>t in r?bt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[t]=n,O=(r,t,n)=>(kt(r,typeof t!="symbol"?t+"":t,n),n);class M{constructor(t,n){O(this,"words"),O(this,"sigBytes"),t=this.words=t||[],this.sigBytes=n===void 0?t.length*4:n}toString(t){return(t||xt).stringify(this)}concat(t){if(this.clamp(),this.sigBytes%4)for(let n=0;n<t.sigBytes;n++){const e=t.words[n>>>2]>>>24-n%4*8&255;this.words[this.sigBytes+n>>>2]|=e<<24-(this.sigBytes+n)%4*8}else for(let n=0;n<t.sigBytes;n+=4)this.words[this.sigBytes+n>>>2]=t.words[n>>>2];return this.sigBytes+=t.sigBytes,this}clamp(){this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4)}clone(){return new M([...this.words])}}const xt={stringify(r){const t=[];for(let n=0;n<r.sigBytes;n++){const e=r.words[n>>>2]>>>24-n%4*8&255;t.push((e>>>4).toString(16),(e&15).toString(16))}return t.join("")}},St={stringify(r){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=[];for(let e=0;e<r.sigBytes;e+=3){const o=r.words[e>>>2]>>>24-e%4*8&255,i=r.words[e+1>>>2]>>>24-(e+1)%4*8&255,s=r.words[e+2>>>2]>>>24-(e+2)%4*8&255,c=o<<16|i<<8|s;for(let a=0;a<4&&e*8+a*6<r.sigBytes*8;a++)n.push(t.charAt(c>>>6*(3-a)&63))}return n.join("")}},Pt={parse(r){const t=r.length,n=[];for(let e=0;e<t;e++)n[e>>>2]|=(r.charCodeAt(e)&255)<<24-e%4*8;return new M(n,t)}},Ct={parse(r){return Pt.parse(unescape(encodeURIComponent(r)))}};class Bt{constructor(){O(this,"_data",new M),O(this,"_nDataBytes",0),O(this,"_minBufferSize",0),O(this,"blockSize",512/32)}reset(){this._data=new M,this._nDataBytes=0}_append(t){typeof t=="string"&&(t=Ct.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes}_doProcessBlock(t,n){}_process(t){let n,e=this._data.sigBytes/(this.blockSize*4);t?e=Math.ceil(e):e=Math.max((e|0)-this._minBufferSize,0);const o=e*this.blockSize,i=Math.min(o*4,this._data.sigBytes);if(o){for(let s=0;s<o;s+=this.blockSize)this._doProcessBlock(this._data.words,s);n=this._data.words.splice(0,o),this._data.sigBytes-=i}return new M(n,i)}}class Lt extends Bt{update(t){return this._append(t),this._process(),this}finalize(t){t&&this._append(t)}}var Et=Object.defineProperty,$t=(r,t,n)=>t in r?Et(r,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):r[t]=n,At=(r,t,n)=>($t(r,t+"",n),n);const Ce=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],Mt=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],F=[];class Tt extends Lt{constructor(){super(...arguments),At(this,"_hash",new M([...Ce]))}reset(){super.reset(),this._hash=new M([...Ce])}_doProcessBlock(t,n){const e=this._hash.words;let o=e[0],i=e[1],s=e[2],c=e[3],a=e[4],f=e[5],d=e[6],p=e[7];for(let u=0;u<64;u++){if(u<16)F[u]=t[n+u]|0;else{const S=F[u-15],$=(S<<25|S>>>7)^(S<<14|S>>>18)^S>>>3,_=F[u-2],x=(_<<15|_>>>17)^(_<<13|_>>>19)^_>>>10;F[u]=$+F[u-7]+x+F[u-16]}const g=a&f^~a&d,b=o&i^o&s^i&s,v=(o<<30|o>>>2)^(o<<19|o>>>13)^(o<<10|o>>>22),k=(a<<26|a>>>6)^(a<<21|a>>>11)^(a<<7|a>>>25),B=p+k+g+Mt[u]+F[u],L=v+b;p=d,d=f,f=a,a=c+B|0,c=s,s=i,i=o,o=B+L|0}e[0]=e[0]+o|0,e[1]=e[1]+i|0,e[2]=e[2]+s|0,e[3]=e[3]+c|0,e[4]=e[4]+a|0,e[5]=e[5]+f|0,e[6]=e[6]+d|0,e[7]=e[7]+p|0}finalize(t){super.finalize(t);const n=this._nDataBytes*8,e=this._data.sigBytes*8;return this._data.words[e>>>5]|=128<<24-e%32,this._data.words[(e+64>>>9<<4)+14]=Math.floor(n/4294967296),this._data.words[(e+64>>>9<<4)+15]=n,this._data.sigBytes=this._data.words.length*4,this._process(),this._hash}}function zt(r){return new Tt().finalize(r).toString(St)}function jt(r,t={}){const n=typeof r=="string"?r:yt(r,t);return zt(n).slice(0,10)}function It(...r){return`${ge}${jt([...r])}`}const Be={...tt},Ft=Object.assign({inheritAttrs:!1},{__name:"Copilot",props:Be,setup(r){const t=r,n=Q(),e=w(),o=j(),{currentContent:i,update:s}=ue(),c=/^<(\w+)>\s*<\/\1>$/,a={blocks:"HTML",writer:"HTML",textarea:"markdown",markdown:"markdown"},f=m(),d=m(),p=m(),u=m(),g=m(),b=m(),v=m(),k=m(),B=m(),L=m(),S=m(),$=m(!1),_=m(!1),x=m(!1),R=m(!1),ie=m(),H=m(),P=m(),se=m([]),K=m([]),$e=m();let T,z;const Ae=A(()=>!_.value&&P.value!==void 0);te(H,h=>{$.value&&g.value&&(h&&h!==p.value?localStorage.setItem(`${T}$prompt`,h):(!h||h===p.value)&&localStorage.removeItem(`${T}$prompt`))}),te(x,h=>{$.value&&g.value&&(h?localStorage.setItem(`${T}$open`,"true"):localStorage.removeItem(`${T}$open`))}),(async()=>{const{load:h}=je(),[C,y]=await Promise.all([Y(),h({parent:t.parent,name:t.name})]);if(f.value=Me(y.label)||e.t("johannschopplich.copilot.label"),d.value=y.field??void 0,p.value=y.userPrompt??void 0,u.value=y.systemPrompt||C.config.systemPrompt||ve,g.value=y.storage,y.editable===!0&&se.value.push("edit"),y.files===!0&&se.value.push("files"),b.value=y.theme||"notice-icon",v.value=y.size||"md",k.value=ot.indexOf(C.config.logLevel??y.logLevel),B.value=y.fieldType,S.value=C.config,$e.value=C.licenseStatus,y.files==="auto"&&y.modelFile){L.value=y.modelFile;const{mime:N,url:J}=y.modelFile;oe.includes(N)&&fetch(J).then(le=>le.blob()).then(le=>{K.value=[le]})}g.value&&(T=It(e.view.path,d.value),H.value=localStorage.getItem(`${T}$prompt`)||p.value||"",x.value=localStorage.getItem(`${T}$open`)==="true",He(()=>{ie.value&&x.value&&(ie.value.open=!0)})),e.events.on("view.save",ce),$.value=!0})(),Ke(()=>{e.events.off("view.save",ce)});function Me(h){return!h||typeof h=="string"?h:h[e.translation.code]??Object.values(h)[0]}async function on(){if(!H.value){e.notification.error(e.t("johannschopplich.copilot.prompt.empty"));return}e.isLoading=!0,_.value=!0,P.value=i.value[d.value],z=new AbortController;let h="",C=Date.now();try{const{textStream:y}=await ye({userPrompt:[H.value,`<response_format>
${Te(B.value)}
</response_format>`].join(`

`),systemPrompt:u.value,files:K.value,logLevel:k.value,abortSignal:z.signal});for await(const N of y)if(h+=N,Array.isArray(P.value)){if(Date.now()-C<S.value.blocksUpdateThrottle)continue;C=Date.now();const J=await ae(h);J.length>0&&await s({[d.value]:[...P.value,...J]},!1)}else await s({[d.value]:P.value+h},!1)}catch(y){if(z=void 0,e.isLoading=!1,_.value=!1,y instanceof Error&&y.name==="AbortError")return;const{AISDKError:N}=await G("ai");if(N.isInstance(y)){console.error(y),e.notification.error(y.message);return}console.error(y),e.notification.error(e.t("johannschopplich.copilot.generator.error"));return}s({[d.value]:Array.isArray(P.value)?[...P.value,...await ae(h)]:P.value+h}),z=void 0,e.isLoading=!1,_.value=!1,e.notification.success({icon:"sparkling",message:e.t("johannschopplich.copilot.generator.success")})}function rn(){z==null||z.abort()}function sn(){s({[d.value]:P.value}),P.value=void 0}async function an(){const h=await _e();K.value=[...K.value,...h]}async function ae(h){if(!h)return[];const{blocks:C}=await o.post("__copilot__/html2blocks",{html:h});return C.length===1&&"text"in C[0].content&&c.test(C[0].content.text)?[]:C}function ce(){Ae.value&&(P.value=void 0)}function Te(h){return a[h]||"text"}return{__sfc:!0,propsDefinition:Be,props:t,_isKirby5:n,panel:e,api:o,currentContent:i,updateContent:s,EMPTY_HTML_TAG_RE:c,RESPONSE_FORMAT_PER_FIELD:a,label:f,field:d,userPrompt:p,systemPrompt:u,storage:g,theme:b,size:v,logLevel:k,fieldType:B,modelFile:L,config:S,isInitialized:$,isGenerating:_,isDetailsOpen:x,isBadgeHovered:R,detailsElement:ie,currentPrompt:H,currentFieldContent:P,allow:se,files:K,licenseStatus:$e,storageKey:T,abortController:z,canUndo:Ae,t:Me,generate:on,abort:rn,undo:sn,pickFiles:an,htmlToBlocks:ae,onModelSave:ce,fieldTypeToResponseFormat:Te,LicensingButtonGroup:me,SUPPORTED_PROVIDERS:he,SUPPORTED_VISION_MIME_TYPES:oe}}});var Ot=function(){var o,i,s,c;var t=this,n=t._self._c,e=t._self._setupProxy;return e.isInitialized?n("k-section",{attrs:{label:e.label}},[e.licenseStatus!==void 0?n("template",{slot:"options"},[n(e.LicensingButtonGroup,{attrs:{label:"Kirby Copilot","api-namespace":"__copilot__","license-status":e.licenseStatus,"pricing-url":"https://kirbycopilot.com/buy"}})],1):t._e(),!e.config.provider||!e.SUPPORTED_PROVIDERS.includes(e.config.provider)?n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Unsupported provider "),n("code",[t._v(t._s(e.config.provider))]),t._v(" in the "),n("code",[t._v("johannschopplich.copilot.provider")]),t._v(" global configuration. ")])],1):(i=(o=e.config.providers)==null?void 0:o[e.config.provider])!=null&&i.apiKey?(c=(s=e.config.providers)==null?void 0:s[e.config.provider])!=null&&c.model?e.field?e.field in e.currentContent?!e.allow.includes("edit")&&!e.userPrompt?n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" If the user prompt cannot be edited by the user, a default "),n("code",[t._v("userPrompt")]),t._v(" has to be set in the section configuration. ")])],1):n("div",{staticClass:"kai-space-y-4"},[n("k-button-group",{attrs:{layout:"collapsed"}},[n("k-button",{attrs:{icon:e.isGenerating?"loader":"sparkling",text:e.panel.t("johannschopplich.copilot.generate"),theme:e.theme,variant:"filled",size:e.size,disabled:e.isGenerating},on:{click:function(a){return e.generate()}}}),e.isGenerating?n("k-button",{attrs:{icon:"cancel",text:e.panel.t("johannschopplich.copilot.stop"),theme:"notice",variant:"filled",size:e.size},on:{click:function(a){return e.abort()}}}):t._e(),e.canUndo?n("k-button",{attrs:{icon:"undo",text:e.panel.t("johannschopplich.copilot.undo"),variant:"filled",size:e.size},on:{click:function(a){return e.undo()}}}):t._e()],1),e.allow.length>0?n("details",{ref:"detailsElement",on:{toggle:function(a){e.isDetailsOpen=a.target.open}}},[n("summary",[t._v(" "+t._s([...e.allow.includes("edit")?[e.panel.t("johannschopplich.copilot.prompt.label")]:[],...e.allow.includes("files")?[e.panel.t("johannschopplich.copilot.context")]:[]].join(", "))+" ")]),n("div",{staticClass:"kai-mt-3"},[e.allow.includes("edit")?n("div",{staticClass:"kai-mb-2 kai-text-right"},[n("k-input",{key:e.isDetailsOpen?1:0,staticClass:"kai-mb-1",attrs:{value:e.currentPrompt,placeholder:e.panel.t("johannschopplich.copilot.prompt.placeholder"),type:"textarea",buttons:!1,counter:!1},on:{input:function(a){e.currentPrompt=a}}}),n("k-button",{directives:[{name:"show",rawName:"v-show",value:e.userPrompt&&e.currentPrompt!==e.userPrompt,expression:"userPrompt && currentPrompt !== userPrompt"}],attrs:{icon:"undo",text:"Reset",variant:"dimmed",size:"xs"},on:{click:function(a){e.currentPrompt=e.userPrompt}}})],1):t._e(),e.allow.includes("files")?n("div",{staticClass:"kai-relative kai-w-max"},[n("k-button",{attrs:{icon:"attachment",text:e.panel.t("johannschopplich.copilot.files.select"),variant:"filled",size:"sm"},on:{click:function(a){return e.pickFiles()}}}),e.files.length>0?n("span",{staticClass:"kai-cursor-pointer",class:[e._isKirby5?"k-button-badge kai-top-[-2px]":"k-tabs-badge kai-top-[-6px]"],attrs:{"data-theme":e.isBadgeHovered?"negative":"notice"},on:{mouseenter:function(a){e.isBadgeHovered=!0},mouseleave:function(a){e.isBadgeHovered=!1},click:function(a){e.files=[],e.isBadgeHovered=!1}}},[t._v(" "+t._s(e.isBadgeHovered?e.panel.t("johannschopplich.copilot.delete"):e.files.length)+" ")]):t._e()],1):e.modelFile?n("k-box",{attrs:{theme:"none"}},[n("k-text",[t._v(" "+t._s(e.panel.t(`johannschopplich.copilot.context.file.${e.SUPPORTED_VISION_MIME_TYPES.includes(e.modelFile.mime)?"model":"unsupported"}`))+" ")])],1):t._e()],1)]):t._e()],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" The "),n("code",[t._v(t._s(e.field))]),t._v(" field does not exist in the current model. ")])],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Missing "),n("code",[t._v("field")]),t._v(" property in the section configuration. It is required for the generated text. ")])],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Missing "),n("code",[t._v("model")]),t._v(" property in the "),n("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1):n("k-box",{attrs:{theme:"empty"}},[n("k-text",[t._v(" Missing "),n("code",[t._v("apiKey")]),t._v(" property in the "),n("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1)],2):t._e()},Rt=[],Dt=W(Ft,Ot,Rt,!1,null,null);const Ut=Dt.exports,Ht=Object.assign({inheritAttrs:!1},{__name:"AutoGrowTextarea",props:{value:{type:String,required:!0},sharedClass:{type:String,default:void 0}},emits:["input","mounted"],setup(r,{emit:t}){const n=r,e=m(),o=A({get(){return n.value},set(i){t("input",i)}});return de(()=>{t("mounted",e.value)}),{__sfc:!0,props:n,emit:t,textarea:e,text:o}}});var Kt=function(){var t=this,n=t._self._c,e=t._self._setupProxy;return n("div",{staticClass:"kai-grid"},[n("textarea",t._b({directives:[{name:"model",rawName:"v-model",value:e.text,expression:"text"}],ref:"textarea",staticClass:"auto-grow-area kai-resize-none kai-overflow-hidden",class:t.sharedClass,domProps:{value:e.text},on:{input:function(o){o.target.composing||(e.text=o.target.value)}}},"textarea",t.$attrs,!1)),t._v(" "),n("div",{staticClass:"auto-grow-area kai-invisible kai-whitespace-pre-wrap",class:t.sharedClass,domProps:{textContent:t._s(`${t.value} `)}})])},Nt=[],qt=W(Ht,Kt,Nt,!1,null,"cd14b042");const Gt=qt.exports,Wt={__name:"PromptDialog",props:{selection:{type:String,default:""}},emits:["cancel","close","input","submit","success"],setup(r,{emit:t}){const n=Q(),e=w(),{lastPrompt:o,addToHistory:i,navigateHistory:s}=vt(),c=m(),a=m([]),f=m("append"),d=m(""),p=m(!1),u=m();pt(c,"keydown",v=>{if(v.metaKey&&v.key==="Enter"&&g(),v.key==="ArrowUp"&&v.target.selectionStart===0||v.key==="ArrowDown"&&v.target.selectionStart===v.target.value.length){v.preventDefault(),v.key==="ArrowUp"&&d.value&&o.value===""&&(o.value=d.value);const k=s(v.key==="ArrowUp"?"up":"down");k!==void 0&&(d.value=k)}}),(async()=>{const v=await Y();u.value=v.licenseStatus})();function g(){i(d.value),t("submit",{prompt:d.value,files:a.value,append:f.value==="append"})}async function b(){const v=await _e();a.value=[...a.value,...v]}return{__sfc:!0,emit:t,_isKirby5:n,panel:e,lastPrompt:o,addToHistory:i,navigateHistory:s,textarea:c,files:a,insertOption:f,prompt:d,isBadgeHovered:p,licenseStatus:u,submit:g,pickFiles:b,LicensingButtonGroup:me,AutoGrowTextarea:Gt}}};var Vt=function(){var t=this,n=t._self._c,e=t._self._setupProxy;return n("k-dialog",{staticClass:"k-copilot-prompt-dialog",attrs:{"cancel-button":!1,"submit-button":!1,visible:!0,size:"medium"},on:{cancel:function(o){return e.emit("cancel")}}},[n("div",{staticClass:"kai-relative kai-rounded-[var(--rounded)] kai-pb-[calc(1rem+32px)] focus-within:kai-outline focus-within:kai-outline-[2px] focus-within:kai-outline-[var(--color-focus,currentColor)]"},[n(e.AutoGrowTextarea,{attrs:{value:e.prompt,"shared-class":"kai-p-2 kai-leading-[1.5] focus:kai-outline-none",placeholder:e.panel.t(t.selection?"johannschopplich.copilot.prompt.dialogContextPlaceholder":"johannschopplich.copilot.prompt.dialogPlaceholder")},on:{input:function(o){e.prompt=o},mounted:function(o){e.textarea=o}}}),n("div",{staticClass:"kai-absolute kai-inset-x-px kai-bottom-px kai-p-2"},[n("div",{staticClass:"kai-flex kai-items-center kai-justify-between"},[n("div",{staticClass:"kai-relative"},[n("k-button",{attrs:{theme:"empty",icon:"attachment"},on:{click:function(o){return e.pickFiles()}}}),e.files.length>0?n("span",{staticClass:"kai-cursor-pointer",class:[e._isKirby5?"k-button-badge kai-top-[-2px]":"k-tabs-badge kai-top-[-6px]"],attrs:{"data-theme":e.isBadgeHovered?"negative":"notice"},on:{mouseenter:function(o){e.isBadgeHovered=!0},mouseleave:function(o){e.isBadgeHovered=!1},click:function(o){e.files=[],e.isBadgeHovered=!1}}},[t._v(" "+t._s(e.isBadgeHovered?e.panel.t("johannschopplich.copilot.delete"):e.files.length)+" ")]):t._e()],1),n("div",{staticClass:"kai-flex kai-gap-2"},[t.selection?n("k-select-input",{staticClass:"k-copilot-prompt-dialog__select",attrs:{options:[{value:"append",text:e.panel.t("johannschopplich.copilot.append")},{value:"replace",text:e.panel.t("johannschopplich.copilot.replace")}],empty:!1,value:e.insertOption},on:{input:function(o){e.insertOption=o}}}):t._e(),n("k-button",{attrs:{theme:"notice-icon",variant:"filled",icon:"sparkling"},on:{click:function(o){return e.submit()}}},[t._v(" "+t._s(e.panel.t("johannschopplich.copilot.generate"))+" ")])],1)])]),e.licenseStatus!==void 0?n(e.LicensingButtonGroup,{staticClass:"kai-absolute kai-right-0 kai-top-[calc(-0.25rem-24px)]",attrs:{label:"Kirby Copilot","api-namespace":"__copilot__","license-status":e.licenseStatus,"pricing-url":"https://kirbycopilot.com/buy"}}):t._e()],1)])},Yt=[],Jt=W(Wt,Vt,Yt,!1,null,null);const Xt=Jt.exports;async function Le(r,{appendText:t,replaceText:n,responseFormat:e="text"}){const o=w(),i=new AbortController,s=p=>{p.key==="Escape"&&i.abort()},c=await Qt({selection:r});if(!c)return;const{prompt:a,files:f}=c;if(!a)return;o.isLoading=!0,document.addEventListener("keydown",s),await Y();const{AISDKError:d}=await G("ai");try{const{textStream:p}=await ye({userPrompt:[a,`<response_format>
${e}
</response_format>`,r&&`<selected_text>
${r}
</selected_text>`].filter(Boolean).join(`

`),systemPrompt:ve,files:f,abortSignal:i.signal});let u=!0;for await(let g of p)c.append?(u&&(g=r?` ${g}`:g,u=!1),t(g)):n(g);o.notification.success({icon:"sparkling",message:o.t("johannschopplich.copilot.generator.success")})}catch(p){if(p instanceof Error&&(p.name==="AbortError"||p.name==="TimeoutError"))return;if(p instanceof re||d.isInstance(p)){console.error(p),o.notification.error(p.message);return}console.error(p),o.notification.error(o.t("johannschopplich.copilot.generator.error"))}finally{o.isLoading=!1,document.removeEventListener("keydown",s)}}async function Qt(r={}){return new Promise(t=>{const n=w();let e;n.dialog.open({component:"k-copilot-prompt-dialog",props:r,on:{close:()=>{t(e)},submit:o=>{e=o,n.dialog.close()}}})})}const Zt={copilot:{icon:"sparkling",label:"Copilot Prompt",click(){let r="";this.command("insert",(o,i)=>(r=i,i));let t=!0;Le(r,{responseFormat:"markdown",appendText:o=>{this.command("insert",(i,s)=>t?(t=!1,s+o):o)},replaceText:o=>{this.command("insert",()=>o)}})},shortcut:"."}},Ee={"***":["bold","italic"],"**":["bold"],"*":["italic"],"`":["code"]},en={copilot:{get button(){return{icon:"sparkling",label:"Copilot Prompt"}},commands(r){return()=>this._openPromptDialog(r)},keys(r){return{"Mod-.":()=>this._openPromptDialog(r)}},get name(){return"copilot"},_insertText(r,t,n,e,o){let i=n;const s=t.split(/(\n\n?|\*{1,3}|`{1,3})/);for(const c of s)if(c===`

`)r=r.replaceWith(i,i,this.editor.options.inline?[o.schema.nodes.hardBreak.create(),o.schema.nodes.hardBreak.create()]:o.schema.nodes.paragraph.create()),i+=2;else if(c===`
`)r=r.replaceWith(i,i,o.schema.nodes.hardBreak.create()),i+=1;else if(c.length>0){if(c in Ee&&!e.lastSegment.includes(c)||[...e.activeMarks].some(a=>a.type.name===c)){for(const a of Ee[c])r=tn(r,a,e,o);e.lastSegment=c;continue}r=r.insertText(c,i),i+=c.length,e.lastSegment=c}return{tr:r,newPosition:i}},_openPromptDialog(r){const{state:t}=this.editor,{from:n,to:e}=t.selection,o=t.doc.textBetween(n,e),i={activeMarks:new Set,lastSegment:""};let s,c=!1;Le(o,{responseFormat:"text",replaceText:d=>{const{state:p,view:u}=this.editor;let g=p.tr;if(!c){const k=nn(p),{from:B,to:L}=p.selection;g=g.deleteRange(B,L),s=k?1:B,c=!0}const{tr:b,newPosition:v}=this._insertText(g,d,s,i,r);s=v,u.dispatch(b)},appendText:d=>{const{state:p,view:u}=this.editor;s=p.selection.to;const{tr:g,newPosition:b}=this._insertText(p.tr,d,s,i,r);s=b,u.dispatch(g)}})}}};function tn(r,t,n,{schema:e}){if([...n.activeMarks].some(o=>o.type.name===t)){n.activeMarks.delete(t);const o=[...n.activeMarks].filter(i=>i.type.name!==t);return r.setStoredMarks(o)}else{const o=e.marks[t].create();return n.activeMarks.add(o),r.addStoredMark(o)}}function nn(r){const t=r.doc.content.size,{from:n,to:e}=r.selection;return n===0&&e===t}window.panel.plugin("johannschopplich/copilot",{components:{"k-copilot-prompt-dialog":Xt},sections:{copilot:Ut},fields:{},textareaButtons:Zt,writerMarks:en})})();
