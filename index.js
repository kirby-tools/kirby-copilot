var en=Object.defineProperty;var tn=(c,b,j)=>b in c?en(c,b,{enumerable:!0,configurable:!0,writable:!0,value:j}):c[b]=j;var E=(c,b,j)=>tn(c,typeof b!="symbol"?b+"":b,j);(function(){"use strict";const c=window.Vue;function b(){return window.panel}function j(){return b().api}const J=()=>window.panel.plugins.viewButtons!==void 0;function $e(){return J()?new Proxy({},{get(){throw new Error("Vuex store is not available. Are you using Kirby 5? Use the `useContent` composable instead.")}}):b().app.$store}function ue(){const r=b(),t=$e(),o=J();if(o&&!("diff"in r.content))throw new Error("This plugin requires Kirby 5.0.0-rc.1 or higher. Please update your Kirby installation.");const e=I(o?()=>r.content.version("changes"):()=>t.getters["content/values"]()),n=I(o?()=>r.content.diff():()=>t.getters["content/changes"]()),i=I(o?()=>r.content.hasDiff():()=>t.getters["content/hasChanges"]()),s=o?r.content:new Proxy({},{get(){return()=>{}}});return{content:s,currentContent:e,contentChanges:n,hasChanges:i,update:async(l,p=!0)=>{if(!o&&l)for(const[d,u]of Object.entries(l))t.dispatch("content/update",[d,u]);const m=s.merge(l);p&&await s.save(m)}}}function Me(){const r=b();function t(o){return!o||typeof o=="string"?o:o[r.translation.code]??Object.values(o)[0]}return{t}}function Te(){const r=j();return{load:({parent:o,name:e})=>r.get(`${o}/sections/${e}`)}}const ze={error:0,warn:1,log:2,info:3,success:3};function je(r){const t=new Fe;return new Proxy({},{get(o,e){return(...n)=>{t.log({level:ze[e],type:e,tag:r,args:n})}}})}class Fe{constructor(){E(this,"defaultColor","#7f8c8d");E(this,"levelColorMap",{0:"#c0392b",1:"#f39c12",3:"#00BCD4"});E(this,"typeColorMap",{success:"#2ecc71"})}log(t){const o=Oe(t.level),e=t.type==="log"?"":t.type,n=t.tag||"",s=`
background: ${this.typeColorMap[t.type]||this.levelColorMap[t.level]||this.defaultColor};
border-radius: 0.5em;
color: white;
font-weight: bold;
padding: 2px 0.5em;
`.trimStart(),a=`%c${[n,e].filter(Boolean).join(":")}`;typeof t.args[0]=="string"?o(`${a}%c ${t.args[0]}`,s,"",...t.args.slice(1)):o(a,s,...t.args)}}function Oe(r){return r<1?console.error:console.log}const Y=[],te=new Map;async function Re(r){if(!Array.isArray(r))throw new TypeError(`Expected an array, got ${typeof r}`);for(const t of r)Y.some(o=>o.filename===t.filename)||Y.push(t)}function pe(r){if(Y.length===0)throw new Error("Plugin assets not registered");const t=Y.find(o=>o.filename===r);if(!t)throw new Error(`Plugin asset "${r}" not found`);return t}async function X(r){if(r.endsWith(".js")||(r+=".js"),te.has(r))return te.get(r);const o=await import(pe(r).url);return te.set(r,o),o}const I=c.computed;c.customRef,c.defineAsyncComponent,c.defineComponent,c.effectScope,c.getCurrentInstance;const De=c.getCurrentScope;c.h,c.inject,c.isProxy,c.isReactive,c.isReadonly,c.isRef,c.isShallow,c.markRaw;const Ue=c.nextTick;c.onActivated,c.onBeforeMount;const Ke=c.onBeforeUnmount;c.onBeforeUpdate,c.onDeactivated,c.onErrorCaptured;const de=c.onMounted;c.onRenderTracked,c.onRenderTriggered;const He=c.onScopeDispose;c.onServerPrefetch,c.onUnmounted,c.onUpdated,c.provide,c.proxyRefs,c.reactive,c.readonly;const f=c.ref;c.shallowReactive,c.shallowReadonly,c.shallowRef,c.toRaw,c.toRef,c.toRefs,c.triggerRef;const ne=c.unref;c.useAttrs,c.useCssModule,c.useCssVars,c.useListeners,c.useSlots;const oe=c.watch;c.watchEffect,c.watchPostEffect,c.watchSyncEffect;const re={en:{"modal.info":"Thanks for purchasing {label}! Please enter your email address and order ID to activate your license.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Find your order number</a> on Lemon Squeezy or <a href="mailto:hello@kirby.tools">contact us</a> if you cannot find it.',"modal.error.required.fields":"Email address and order ID are required","modal.error.invalid.unauthorized":"Email address or order ID is incorrect","modal.error.invalid.licenseKey":"License key invalid for this plugin","modal.error.incompatible":"License key invalid for this plugin version","modal.error.upgradeable":"License key invalid for this plugin version. Upgrade now on https://hub.kirby.tools.","modal.error.activated":"License key already activated",activate:"Activate",activated:"Plugin activated",buy:"Buy a license",upgrade:"Upgrade"},de:{"modal.info":"Dankeschön für den Kauf von {label}! Bitte gib deine E-Mail-Adresse und Bestellnummer ein, um deine Lizenz zu aktivieren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Finde deine Bestellnummer</a> bei Lemon Squeezy oder <a href="mailto:hello@kirby.tools">kontaktiere uns</a>, wenn du sie nicht finden kannst.',"modal.error.required.fields":"E-Mail-Adresse und Bestellnummer sind notwendig","modal.error.invalid.unauthorized":"E-Mail-Adresse oder Bestellnummer ist falsch","modal.error.invalid.licenseKey":"Lizenzschlüssel ungültig für dieses Plugin","modal.error.incompatible":"Lizenzschlüssel ungültig für diese Plugin-Version","modal.error.upgradeable":"Lizenzschlüssel ungültig für diese Plugin-Version. Aktualisiere jetzt auf https://hub.kirby.tools.","modal.error.activated":"Lizenzschlüssel bereits aktiviert",activate:"Aktivieren",activated:"Plugin aktiviert",buy:"Lizenz kaufen",upgrade:"Upgrade"},fr:{"modal.info":"Merci d'avoir acheté {label} ! Veuillez saisir votre adresse e-mail et votre numéro de commande pour activer votre licence.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Trouvez votre numéro de commande</a> sur Lemon Squeezy ou <a href="mailto:hello@kirby.tools">contactez-nous</a> si vous ne le trouvez pas.',"modal.error.required.fields":"Adresse e-mail et numéro de commande requis","modal.error.invalid.unauthorized":"Adresse e-mail ou numéro de commande incorrect","modal.error.invalid.licenseKey":"Clé de licence invalide pour ce plugin","modal.error.incompatible":"Clé de licence invalide pour cette version du plugin","modal.error.upgradeable":"Clé de licence invalide pour cette version du plugin. Mettez à niveau maintenant sur https://hub.kirby.tools.","modal.error.activated":"Clé de licence déjà activée",activate:"Activer",activated:"Plugin activé",buy:"Acheter une licence",upgrade:"Upgrade"},nl:{"modal.info":"Bedankt voor het kopen van {label}! Voer je e-mailadres en bestelnummer in om je licentie te activeren.","modal.fields.orderId.help":'<a href="https://app.lemonsqueezy.com/my-orders" target="_blank">Vind je bestelnummer</a> op Lemon Squeezy of <a href="mailto:hello@kirby.tools">neem contact met ons op</a> als je het niet kunt vinden.',"modal.error.required.fields":"E-mailadres en bestelnummer zijn verplicht","modal.error.invalid.unauthorized":"E-mailadres of bestelnummer is onjuist","modal.error.invalid.licenseKey":"Licentiesleutel ongeldig voor dit plug-in","modal.error.incompatible":"Licentiesleutel ongeldig voor deze plug-inversie","modal.error.upgradeable":"Licentiesleutel ongeldig voor deze plug-inversie. Upgrade nu op https://hub.kirby.tools.","modal.error.activated":"Licentiesleutel al geactiveerd",activate:"Activeren",activated:"Plugin geactiveerd",buy:"Koop een licentie",upgrade:"Upgrade"}},Ne=["localhost","127.0.0.1","[::1]"],qe=["local","test","ddev.site"];function F(r="",t){var n;const o=window.panel.translation.code,e=((n=re==null?void 0:re[o])==null?void 0:n[r])??r;return t?Ge(e,t):e}function Ge(r,t,o){return r.replace(/\{(\w+)\}/g,(e,n)=>t[n]||n)}function Ve(){const{hostname:r}=window.location,t=Ne.includes(r),o=qe.some(e=>r.endsWith(`.${e}`));return t||o}const fe={Unauthorized:"modal.error.invalid.unauthorized","License key not valid for this plugin":"modal.error.invalid.licenseKey","License key not valid for this plugin version":"modal.error.incompatible","License key not valid for this plugin version, please upgrade your license":"modal.error.upgradeable","License key already activated":"modal.error.activated"};function We(r){const t=b();return{isLocalhost:Ve(),assertActivationIntegrity:async({component:i,licenseStatus:s})=>{if(ne(s)==="active")return;const a=ne(i);if(!(a!=null&&a.$el)||window.getComputedStyle(a.$el).display==="none"||window.getComputedStyle(a.$el).visibility==="hidden"||window.getComputedStyle(a.$el).opacity==="0")throw new Error("Are you trying to hide the activation buttons? Please buy a license.")},openLicenseModal:()=>{let i=!1;const{label:s}=r,a={info:{type:"info",text:F("modal.info",{label:s})},email:{label:t.t("email"),type:"email"},orderId:{label:"Order ID",type:"text",help:F("modal.fields.orderId.help",{label:s})}};return new Promise(l=>{t.dialog.open({component:"k-form-dialog",props:{submitButton:{icon:"check",theme:"love",text:F("activate",{label:s})},fields:a},on:{close:()=>{l({isLicenseActive:i})},submit:async p=>{i=await Je(p,r),i&&(t.dialog.close(),t.notification.success(F("activated")))}}})})}}}async function Je(r,t){const o=b(),{email:e,orderId:n}=r;if(!e||!n)return o.notification.error(F("modal.error.required.fields")),!1;try{const i=await o.api.post(`${t.apiNamespace}/activate`,{email:e,orderId:Number(n)});if((i==null?void 0:i.status)!=="ok")throw new Error("Failed to activate license key");return!0}catch(i){const s=i.message;return o.notification.error(fe[s]?F(fe[s]):s),!1}}const Ye=Vue.defineComponent({__name:"LicensingButtonGroup",props:{label:{type:String,required:!0},apiNamespace:{type:String,required:!0},licenseStatus:{type:String,required:!0},pricingUrl:{type:String,required:!0}},setup(r){const t=r,{openLicenseModal:o,assertActivationIntegrity:e}=We({label:t.label,apiNamespace:t.apiNamespace}),n=f(t.licenseStatus),i=f();de(()=>{e({component:i,licenseStatus:t.licenseStatus})});async function s(){const{isLicenseActive:a}=await o();a&&window.location.reload()}return{__sfc:!0,props:t,openLicenseModal:o,assertActivationIntegrity:e,currentLicenseStatus:n,licenseButtonGroup:i,handleRegistration:s,t:F}}});function Q(r,t,o,e,n,i,s,a){var l=typeof r=="function"?r.options:r;return t&&(l.render=t,l.staticRenderFns=o,l._compiled=!0),i&&(l._scopeId="data-v-"+i),{exports:r,options:l}}var Xe=function(){var t=this,o=t._self._c,e=t._self._setupProxy;return e.currentLicenseStatus!=="active"?o("k-button-group",{ref:"licenseButtonGroup",attrs:{layout:"collapsed"}},[o("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",link:e.currentLicenseStatus==="upgradeable"?"https://hub.kirby.tools":t.pricingUrl,target:"_blank",text:e.currentLicenseStatus==="upgradeable"?e.t("upgrade"):e.t("buy")}}),o("k-button",{attrs:{theme:"love",variant:"filled",size:"xs",icon:"key",text:e.t("activate")},on:{click:function(n){return e.handleRegistration()}}})],1):t._e()},Qe=[],Ze=Q(Ye,Xe,Qe,!1,null,null);const me=Ze.exports,et="__copilot__/context",he=["anthropic","mistral","openai"],ie=["image/png","image/jpeg","image/webp","image/gif"],tt=["error","warn","info","debug"],nt="kirby$copilot$",ge=`
You are an AI assistant integrated into a Content Management System (CMS). Your primary task is to answer user questions accurately and helpfully.

Instructions:
- If selected_text is provided, consider the selected text as context for the user's question.
- If pdf_documents are provided, additional context from PDF documents have been processed and made available to you. Consider the information from these documents as applicable.

Output Format:
- If response_format is set to "text", format your response in plain text. Do not include any Markdown syntax.
- If response_format is set to "HTML", format your response using HTML syntax. Do not include any other parts of a full HTML document structure, except for the content of the <body> element. Structure your response using appropriate HTML tags. Use <h2> or <h3> tags for section headings.
- If response_format is set to "markdown", format your response using Markdown syntax. Do not use backticks or any other wrapping characters around your response.
`;class U extends Error{}let K;async function ot(r){const t=await it(),o=await r.arrayBuffer(),e=await t.getDocument({data:o,useSystemFonts:!0}).promise;return(await Promise.all(Array.from({length:e.numPages},(i,s)=>rt(e,s+1)))).map(i=>i.replace(/\s+/g," ")).join(`
`)}async function rt(r,t){return(await(await r.getPage(t)).getTextContent()).items.filter(n=>n.str!=null).map(n=>n.str).join(" ")}async function it(){if(K)return K;K=await X("pdfjs");const r=pe("pdfjs.worker.js");return K.GlobalWorkerOptions.workerSrc=r.url,K}function st(r,t,o){return r.replace(/\{(\w+)\}/g,(e,n)=>t[n.toLowerCase()]||n)}async function at({accept:r="*",multiple:t=!0}={}){const o=document.createElement("input");return o.type="file",o.classList.add("sr-only"),o.value=null,o.accept=r,o.multiple=t,o.click(),new Promise(e=>{o.addEventListener("change",n=>{var i;e([...((i=n.target)==null?void 0:i.files)??[]]),o.remove()},{once:!0})})}async function lt(r,t){const o=await ct(r);return await ut(o,r.type,t)}async function ct(r,t={}){if(!r.type.startsWith("image/"))throw new TypeError(`MIME type must be an image, but got: ${r.type}`);const o=new Image,e=URL.createObjectURL(r);t.crossOrigin&&(o.crossOrigin=t.crossOrigin);try{return await new Promise((i,s)=>{o.addEventListener("load",()=>{i(o)}),o.addEventListener("error",s),o.src=e})}finally{URL.revokeObjectURL(e)}}async function ut(r,t,o){if(!r.complete||!r.naturalWidth)throw new Error("Image has not been properly loaded");if(!t.startsWith("image/"))throw new Error(`Blob type must be an image, but got: ${t}`);const e=document.createElement("canvas"),n=e.getContext("2d"),i=Math.min(1,o/Math.max(r.width,r.height)),s=Math.round(r.width*i),a=Math.round(r.height*i);e.width=s,e.height=a,n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high",n.drawImage(r,0,0,s,a);const l=await new Promise(p=>{e.toBlob(p,t)});if(!l)throw new Error("Failed to convert canvas to Blob");return l}function pt(){const{currentContent:r}=ue(),t={...r.value,title:window.panel.view.title};return Object.fromEntries(Object.entries(t).map(([o,e])=>[o,Array.isArray(e)||typeof e=="object"&&e!==null?JSON.stringify(e):e]))}let dt;function ft(){return dt??(dt=je("copilot"))}let Z,H;function ee(){return Z||H||(H=window.panel.api.get(et).then(r=>(Re(r.assets),Z=r,H=void 0,Z)),H)}async function ve({userPrompt:r,systemPrompt:t,files:o=[],logLevel:e=1,abortSignal:n}){var M,P;const i=ft();let{config:s}=await ee();if(!s.provider||!he.includes(s.provider))throw new U(`Unsupported provider "${s.provider}" in the "johannschopplich.copilot.provider" global configuration.`);for(const _ of["apiKey","model"])if(!((P=(M=s.providers)==null?void 0:M[s.provider])!=null&&P[_]))throw new U(`Missing "${_}" property in the "johannschopplich.copilot.providers.${s.provider}" global configuration.`);const{AISDKError:a,APICallError:l,createAnthropic:p,createMistral:m,createOpenAI:d,streamText:u}=await X("ai"),h=s.provider,v=s.providers[h],A={mistral:m,openai:d,anthropic:p}[h],y=A({baseUrl:v.baseUrl||void 0,apiKey:v.apiKey}),x=pt();let S=st(r,x);const R=o.filter(_=>_.type.startsWith("image/")),L=o.filter(_=>_.type==="application/pdf");if(L.length>0){const _=await Promise.all(L.map(ot));S+=`

${_.map((k,N)=>`<pdf_document_${N+1}>
${k}
</pdf_document_${N+1}>`).join(`

`)}`}if(e>1&&(i.info("System prompt:",t),i.info("User prompt with context:",S)),R.length>0){if(v.model==="o3-mini")throw new U(`OpenAI's "o3-mini" model does not support images. Please use a different model, such as "gpt-4o".`);const _=await Promise.all(R.map(async k=>{const q=await(await lt(k,2048)).arrayBuffer();return new Uint8Array(q)}));return u({model:y.languageModel(v.model),temperature:s.temperature,system:t||void 0,messages:[{role:"user",content:[{type:"text",text:S},..._.map(k=>({type:"image",image:k}))]}],abortSignal:n,onError({error:k}){if(a.isInstance(k)||l.isInstance(k))throw k}})}return u({model:y.languageModel(v.model),temperature:s.temperature,system:t||void 0,prompt:S,abortSignal:n,onError({error:_}){if(a.isInstance(_)||l.isInstance(_))throw _}})}function mt(r,t,o,e){let n;const i=()=>{n==null||n(),n=void 0},s=(p,m,d,u)=>(p.addEventListener(m,d,u),()=>p.removeEventListener(m,d,u)),a=oe(()=>ht(r),p=>{i(),p&&(n=s(p,t,o,e))},{immediate:!0,flush:"post"}),l=()=>{a(),i()};return De()&&He(l),l}function ht(r){const t=ne(r);return(t==null?void 0:t.$el)??t}function ye(){return at({accept:[...ie,"application/pdf"].join(",")})}const _e=Object.freeze({ignoreUnknown:!1,respectType:!1,respectFunctionNames:!1,respectFunctionProperties:!1,unorderedObjects:!0,unorderedArrays:!1,unorderedSets:!1,excludeKeys:void 0,excludeValues:void 0,replacer:void 0});function gt(r,t){t?t={..._e,...t}:t=_e;const o=we(t);return o.dispatch(r),o.toString()}const vt=Object.freeze(["prototype","__proto__","constructor"]);function we(r){let t="",o=new Map;const e=n=>{t+=n};return{toString(){return t},getContext(){return o},dispatch(n){return r.replacer&&(n=r.replacer(n)),this[n===null?"null":typeof n](n)},object(n){if(n&&typeof n.toJSON=="function")return this.object(n.toJSON());const i=Object.prototype.toString.call(n);let s="";const a=i.length;a<10?s="unknown:["+i+"]":s=i.slice(8,a-1),s=s.toLowerCase();let l=null;if((l=o.get(n))===void 0)o.set(n,o.size);else return this.dispatch("[CIRCULAR:"+l+"]");if(typeof Buffer<"u"&&Buffer.isBuffer&&Buffer.isBuffer(n))return e("buffer:"),e(n.toString("utf8"));if(s!=="object"&&s!=="function"&&s!=="asyncfunction")this[s]?this[s](n):r.ignoreUnknown||this.unkown(n,s);else{let p=Object.keys(n);r.unorderedObjects&&(p=p.sort());let m=[];r.respectType!==!1&&!ke(n)&&(m=vt),r.excludeKeys&&(p=p.filter(u=>!r.excludeKeys(u)),m=m.filter(u=>!r.excludeKeys(u))),e("object:"+(p.length+m.length)+":");const d=u=>{this.dispatch(u),e(":"),r.excludeValues||this.dispatch(n[u]),e(",")};for(const u of p)d(u);for(const u of m)d(u)}},array(n,i){if(i=i===void 0?r.unorderedArrays!==!1:i,e("array:"+n.length+":"),!i||n.length<=1){for(const l of n)this.dispatch(l);return}const s=new Map,a=n.map(l=>{const p=we(r);p.dispatch(l);for(const[m,d]of p.getContext())s.set(m,d);return p.toString()});return o=s,a.sort(),this.array(a,!1)},date(n){return e("date:"+n.toJSON())},symbol(n){return e("symbol:"+n.toString())},unkown(n,i){if(e(i),!!n&&(e(":"),n&&typeof n.entries=="function"))return this.array(Array.from(n.entries()),!0)},error(n){return e("error:"+n.toString())},boolean(n){return e("bool:"+n)},string(n){e("string:"+n.length+":"),e(n)},function(n){e("fn:"),ke(n)?this.dispatch("[native]"):this.dispatch(n.toString()),r.respectFunctionNames!==!1&&this.dispatch("function-name:"+String(n.name)),r.respectFunctionProperties&&this.object(n)},number(n){return e("number:"+n)},xml(n){return e("xml:"+n.toString())},null(){return e("Null")},undefined(){return e("Undefined")},regexp(n){return e("regex:"+n.toString())},uint8array(n){return e("uint8array:"),this.dispatch(Array.prototype.slice.call(n))},uint8clampedarray(n){return e("uint8clampedarray:"),this.dispatch(Array.prototype.slice.call(n))},int8array(n){return e("int8array:"),this.dispatch(Array.prototype.slice.call(n))},uint16array(n){return e("uint16array:"),this.dispatch(Array.prototype.slice.call(n))},int16array(n){return e("int16array:"),this.dispatch(Array.prototype.slice.call(n))},uint32array(n){return e("uint32array:"),this.dispatch(Array.prototype.slice.call(n))},int32array(n){return e("int32array:"),this.dispatch(Array.prototype.slice.call(n))},float32array(n){return e("float32array:"),this.dispatch(Array.prototype.slice.call(n))},float64array(n){return e("float64array:"),this.dispatch(Array.prototype.slice.call(n))},arraybuffer(n){return e("arraybuffer:"),this.dispatch(new Uint8Array(n))},url(n){return e("url:"+n.toString())},map(n){e("map:");const i=[...n];return this.array(i,r.unorderedSets!==!1)},set(n){e("set:");const i=[...n];return this.array(i,r.unorderedSets!==!1)},file(n){return e("file:"),this.dispatch([n.name,n.size,n.type,n.lastModfied])},blob(){if(r.ignoreUnknown)return e("[blob]");throw new Error(`Hashing Blob objects is currently not supported
Use "options.replacer" or "options.ignoreUnknown"
`)},domwindow(){return e("domwindow")},bigint(n){return e("bigint:"+n.toString())},process(){return e("process")},timer(){return e("timer")},pipe(){return e("pipe")},tcp(){return e("tcp")},udp(){return e("udp")},tty(){return e("tty")},statwatcher(){return e("statwatcher")},securecontext(){return e("securecontext")},connection(){return e("connection")},zlib(){return e("zlib")},context(){return e("context")},nodescript(){return e("nodescript")},httpparser(){return e("httpparser")},dataview(){return e("dataview")},signal(){return e("signal")},fsevent(){return e("fsevent")},tlswrap(){return e("tlswrap")}}}const be="[native code] }",yt=be.length;function ke(r){return typeof r!="function"?!1:Function.prototype.toString.call(r).slice(-yt)===be}class ${constructor(t,o){E(this,"words");E(this,"sigBytes");t=this.words=t||[],this.sigBytes=o===void 0?t.length*4:o}toString(t){return(t||_t).stringify(this)}concat(t){if(this.clamp(),this.sigBytes%4)for(let o=0;o<t.sigBytes;o++){const e=t.words[o>>>2]>>>24-o%4*8&255;this.words[this.sigBytes+o>>>2]|=e<<24-(this.sigBytes+o)%4*8}else for(let o=0;o<t.sigBytes;o+=4)this.words[this.sigBytes+o>>>2]=t.words[o>>>2];return this.sigBytes+=t.sigBytes,this}clamp(){this.words[this.sigBytes>>>2]&=4294967295<<32-this.sigBytes%4*8,this.words.length=Math.ceil(this.sigBytes/4)}clone(){return new $([...this.words])}}const _t={stringify(r){const t=[];for(let o=0;o<r.sigBytes;o++){const e=r.words[o>>>2]>>>24-o%4*8&255;t.push((e>>>4).toString(16),(e&15).toString(16))}return t.join("")}},wt={stringify(r){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",o=[];for(let e=0;e<r.sigBytes;e+=3){const n=r.words[e>>>2]>>>24-e%4*8&255,i=r.words[e+1>>>2]>>>24-(e+1)%4*8&255,s=r.words[e+2>>>2]>>>24-(e+2)%4*8&255,a=n<<16|i<<8|s;for(let l=0;l<4&&e*8+l*6<r.sigBytes*8;l++)o.push(t.charAt(a>>>6*(3-l)&63))}return o.join("")}},bt={parse(r){const t=r.length,o=[];for(let e=0;e<t;e++)o[e>>>2]|=(r.charCodeAt(e)&255)<<24-e%4*8;return new $(o,t)}},kt={parse(r){return bt.parse(unescape(encodeURIComponent(r)))}};class xt{constructor(){E(this,"_data",new $);E(this,"_nDataBytes",0);E(this,"_minBufferSize",0);E(this,"blockSize",512/32)}reset(){this._data=new $,this._nDataBytes=0}_append(t){typeof t=="string"&&(t=kt.parse(t)),this._data.concat(t),this._nDataBytes+=t.sigBytes}_doProcessBlock(t,o){}_process(t){let o,e=this._data.sigBytes/(this.blockSize*4);t?e=Math.ceil(e):e=Math.max((e|0)-this._minBufferSize,0);const n=e*this.blockSize,i=Math.min(n*4,this._data.sigBytes);if(n){for(let s=0;s<n;s+=this.blockSize)this._doProcessBlock(this._data.words,s);o=this._data.words.splice(0,n),this._data.sigBytes-=i}return new $(o,i)}}class St extends xt{update(t){return this._append(t),this._process(),this}finalize(t){t&&this._append(t)}}const xe=[1779033703,-1150833019,1013904242,-1521486534,1359893119,-1694144372,528734635,1541459225],Pt=[1116352408,1899447441,-1245643825,-373957723,961987163,1508970993,-1841331548,-1424204075,-670586216,310598401,607225278,1426881987,1925078388,-2132889090,-1680079193,-1046744716,-459576895,-272742522,264347078,604807628,770255983,1249150122,1555081692,1996064986,-1740746414,-1473132947,-1341970488,-1084653625,-958395405,-710438585,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,-2117940946,-1838011259,-1564481375,-1474664885,-1035236496,-949202525,-778901479,-694614492,-200395387,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,-2067236844,-1933114872,-1866530822,-1538233109,-1090935817,-965641998],O=[];class Ct extends St{constructor(){super(...arguments);E(this,"_hash",new $([...xe]))}reset(){super.reset(),this._hash=new $([...xe])}_doProcessBlock(o,e){const n=this._hash.words;let i=n[0],s=n[1],a=n[2],l=n[3],p=n[4],m=n[5],d=n[6],u=n[7];for(let h=0;h<64;h++){if(h<16)O[h]=o[e+h]|0;else{const L=O[h-15],M=(L<<25|L>>>7)^(L<<14|L>>>18)^L>>>3,P=O[h-2],_=(P<<15|P>>>17)^(P<<13|P>>>19)^P>>>10;O[h]=M+O[h-7]+_+O[h-16]}const v=p&m^~p&d,A=i&s^i&a^s&a,y=(i<<30|i>>>2)^(i<<19|i>>>13)^(i<<10|i>>>22),x=(p<<26|p>>>6)^(p<<21|p>>>11)^(p<<7|p>>>25),S=u+x+v+Pt[h]+O[h],R=y+A;u=d,d=m,m=p,p=l+S|0,l=a,a=s,s=i,i=S+R|0}n[0]=n[0]+i|0,n[1]=n[1]+s|0,n[2]=n[2]+a|0,n[3]=n[3]+l|0,n[4]=n[4]+p|0,n[5]=n[5]+m|0,n[6]=n[6]+d|0,n[7]=n[7]+u|0}finalize(o){super.finalize(o);const e=this._nDataBytes*8,n=this._data.sigBytes*8;return this._data.words[n>>>5]|=128<<24-n%32,this._data.words[(n+64>>>9<<4)+14]=Math.floor(e/4294967296),this._data.words[(n+64>>>9<<4)+15]=e,this._data.sigBytes=this._data.words.length*4,this._process(),this._hash}}function Bt(r){return new Ct().finalize(r).toString(wt)}function Lt(r,t={}){const o=typeof r=="string"?r:gt(r,t);return Bt(o).slice(0,10)}function Se(...r){return`${nt}${Lt([...r])}`}const Pe=50;function Et(){const r=Se("history",window.location.hostname),t=f(JSON.parse(localStorage.getItem(r)||"[]")),o=f(""),e=f(-1);function n(s){if(!s)return;const a=t.value.indexOf(s);a!==-1&&t.value.splice(a,1),t.value.unshift(s),t.value.length>Pe&&(t.value=t.value.slice(0,Pe)),localStorage.setItem(r,JSON.stringify(t.value)),e.value=-1}function i(s){if(s==="up"){if(e.value+1<t.value.length)return e.value++,t.value[e.value]}else if(s==="down"){if(e.value>0)return e.value--,t.value[e.value];if(e.value===0)return e.value=-1,o.value}}return{lastPrompt:o,currentIndex:e,addToHistory:n,navigateHistory:i}}const At=Object.assign({inheritAttrs:!1},{__name:"AutoGrowTextarea",props:{value:{type:String,required:!0},sharedClass:{type:String,default:void 0}},emits:["input","mounted"],setup(r,{emit:t}){const o=r,e=f(),n=I({get(){return o.value},set(i){t("input",i)}});return de(()=>{t("mounted",e.value)}),{__sfc:!0,props:o,emit:t,textarea:e,text:n}}});var It=function(){var t=this,o=t._self._c,e=t._self._setupProxy;return o("div",{staticClass:"kai-grid"},[o("textarea",t._b({directives:[{name:"model",rawName:"v-model",value:e.text,expression:"text"}],ref:"textarea",staticClass:"stack-layer kai-resize-none kai-overflow-hidden",class:t.sharedClass,domProps:{value:e.text},on:{input:function(n){n.target.composing||(e.text=n.target.value)}}},"textarea",t.$attrs,!1)),t._v(" "),o("div",{staticClass:"stack-layer kai-invisible kai-whitespace-pre-wrap",class:t.sharedClass,domProps:{textContent:t._s(`${t.value} `)}})])},$t=[],Mt=Q(At,It,$t,!1,null,"a814ce2d");const Tt=Mt.exports,zt={__name:"Prompt",props:{selection:{type:String,default:""}},emits:["cancel","close","input","submit","success"],setup(r,{emit:t}){const o=J(),e=b(),{lastPrompt:n,currentIndex:i,addToHistory:s,navigateHistory:a}=Et(),l=f(),p=f([]),m=f("append"),d=f(""),u=f(!1),h=f();mt(l,"keydown",y=>{if(y.metaKey&&y.key==="Enter"&&v(),y.key==="ArrowUp"&&y.target.selectionStart===0||y.key==="ArrowDown"&&y.target.selectionStart===y.target.value.length){y.preventDefault(),y.key==="ArrowUp"&&i.value===-1&&(n.value=d.value);const x=a(y.key==="ArrowUp"?"up":"down");x!==void 0&&(d.value=x)}}),(async()=>{const y=await ee();h.value=y.licenseStatus})();function v(){s(d.value),t("submit",{prompt:d.value,files:p.value,append:m.value==="append"})}async function A(){const y=await ye();p.value=[...p.value,...y]}return{__sfc:!0,emit:t,_isKirby5:o,panel:e,lastPrompt:n,currentIndex:i,addToHistory:s,navigateHistory:a,textarea:l,files:p,insertOption:m,prompt:d,isBadgeHovered:u,licenseStatus:h,submit:v,pickFiles:A,LicensingButtonGroup:me,AutoGrowTextarea:Tt}}};var jt=function(){var t=this,o=t._self._c,e=t._self._setupProxy;return o("k-dialog",{staticClass:"k-copilot-prompt-dialog",attrs:{"cancel-button":!1,"submit-button":!1,visible:!0,size:"medium"},on:{cancel:function(n){return e.emit("cancel")}}},[o("div",{staticClass:"kai-relative kai-rounded-[var(--rounded)] kai-pb-[calc(1rem+32px)] focus-within:kai-outline focus-within:kai-outline-[2px] focus-within:kai-outline-[var(--color-focus,currentColor)]"},[o(e.AutoGrowTextarea,{attrs:{value:e.prompt,"shared-class":"kai-p-2 kai-leading-[1.5] focus:kai-outline-none",placeholder:e.panel.t(t.selection?"johannschopplich.copilot.prompt.dialogContextPlaceholder":"johannschopplich.copilot.prompt.dialogPlaceholder")},on:{input:function(n){e.prompt=n},mounted:function(n){e.textarea=n}}}),o("div",{staticClass:"kai-absolute kai-inset-x-px kai-bottom-px kai-p-2"},[o("div",{staticClass:"kai-flex kai-items-center kai-justify-between"},[o("div",{staticClass:"kai-relative"},[o("k-button",{attrs:{theme:"empty",icon:"attachment"},on:{click:function(n){return e.pickFiles()}}}),e.files.length>0?o("span",{staticClass:"kai-cursor-pointer",class:[e._isKirby5?"k-button-badge kai-top-[-2px]":"k-tabs-badge kai-top-[-6px]"],attrs:{"data-theme":e.isBadgeHovered?"negative":"notice"},on:{mouseenter:function(n){e.isBadgeHovered=!0},mouseleave:function(n){e.isBadgeHovered=!1},click:function(n){e.files=[],e.isBadgeHovered=!1}}},[t._v(" "+t._s(e.isBadgeHovered?e.panel.t("johannschopplich.copilot.delete"):e.files.length)+" ")]):t._e()],1),o("div",{staticClass:"kai-flex kai-gap-2"},[t.selection?o("k-select-input",{staticClass:"kai-underline kai-underline-offset-[var(--link-underline-offset)]",attrs:{options:[{value:"append",text:e.panel.t("johannschopplich.copilot.append")},{value:"replace",text:e.panel.t("johannschopplich.copilot.replace")}],empty:!1,value:e.insertOption},on:{input:function(n){e.insertOption=n}}}):t._e(),o("k-button",{attrs:{theme:"notice-icon",variant:"filled",icon:"sparkling"},on:{click:function(n){return e.submit()}}},[t._v(" "+t._s(e.panel.t("johannschopplich.copilot.generate"))+" ")])],1)])]),e.licenseStatus!==void 0?o(e.LicensingButtonGroup,{staticClass:"kai-absolute kai-right-0 kai-top-[calc(-0.25rem-24px)]",attrs:{label:"Kirby Copilot","api-namespace":"__copilot__","license-status":e.licenseStatus,"pricing-url":"https://kirby.tools/copilot/buy"}}):t._e()],1)])},Ft=[],Ot=Q(zt,jt,Ft,!1,null,null);const Rt=Ot.exports,Ce={...{blueprint:String,lock:[Boolean,Object],help:String,name:String,parent:String,timestamp:Number}},Dt=Object.assign({inheritAttrs:!1},{__name:"Copilot",props:Ce,setup(r){const t=r,o=J(),e=b(),n=j(),{t:i}=Me(),{currentContent:s,update:a}=ue(),l=/^<(\w+)>\s*<\/\1>$/,p={blocks:"HTML",writer:"HTML",textarea:"markdown",markdown:"markdown"},m=f(),d=f(),u=f(),h=f(),v=f(),A=f(),y=f(),x=f(),S=f(),R=f(),L=f(),M=f(),P=f(!1),_=f(!1),k=f(!1),N=f(!1),q=f(),G=f(),C=f(),se=f([]),V=f([]),Ee=f();let T,z;const Ae=I(()=>!_.value&&C.value!==void 0);oe(G,w=>{P.value&&v.value&&(w&&w!==u.value?localStorage.setItem(`${T}$prompt`,w):(!w||w===u.value)&&localStorage.removeItem(`${T}$prompt`))}),oe(k,w=>{P.value&&v.value&&(w?localStorage.setItem(`${T}$open`,"true"):localStorage.removeItem(`${T}$open`))}),(async()=>{const{load:w}=Te(),[B,g]=await Promise.all([ee(),w({parent:t.parent,name:t.name})]);if(m.value=i(g.label)||e.t("johannschopplich.copilot.label"),d.value=g.field??void 0,u.value=g.userPrompt??void 0,h.value=g.systemPrompt||B.config.systemPrompt||ge,v.value=g.storage,g.editable===!0&&se.value.push("edit"),g.files===!0&&se.value.push("files"),A.value=g.theme||"notice-icon",y.value=g.size||"md",x.value=tt.indexOf(B.config.logLevel??g.logLevel),S.value=g.fieldType,L.value=g.help?i(g.help):void 0,M.value=B.config,Ee.value=B.licenseStatus,g.files==="auto"&&g.modelFile){R.value=g.modelFile;const{mime:W,url:D}=g.modelFile;ie.includes(W)&&fetch(D).then(ce=>ce.blob()).then(ce=>{V.value=[ce]})}v.value&&(T=Se(e.view.path,d.value),G.value=localStorage.getItem(`${T}$prompt`)||u.value||"",k.value=localStorage.getItem(`${T}$open`)==="true"||g.open,Ue(()=>{q.value&&k.value&&(q.value.open=!0)})),e.events.on("view.save",le),P.value=!0})(),Ke(()=>{e.events.off("view.save",le)});async function Yt(){if(!G.value){e.notification.error(e.t("johannschopplich.copilot.prompt.empty"));return}e.isLoading=!0,_.value=!0,C.value=s.value[d.value],z=new AbortController;let w="",B=Date.now();try{const{textStream:g}=await ve({userPrompt:[G.value,`<response_format>
${Ie(S.value)}
</response_format>`].join(`

`),systemPrompt:h.value,files:V.value,logLevel:x.value,abortSignal:z.signal});for await(const W of g)if(w+=W,Array.isArray(C.value)){if(Date.now()-B<M.value.blocksUpdateThrottle)continue;B=Date.now();const D=await ae(w);D.length>0&&await a({[d.value]:[...C.value,...D]},!1)}else await a({[d.value]:C.value+w},!1)}catch(g){if(z=void 0,e.isLoading=!1,_.value=!1,g instanceof Error&&(g.name==="AbortError"||g.name==="TimeoutError"))return;const{AISDKError:W,APICallError:D}=await X("ai");if(g instanceof U||W.isInstance(g)||D.isInstance(g)){console.error(g),e.notification.error(g.message);return}console.error(g),e.notification.error(e.t("johannschopplich.copilot.generator.error"));return}a({[d.value]:Array.isArray(C.value)?[...C.value,...await ae(w)]:C.value+w}),z=void 0,e.isLoading=!1,_.value=!1,e.notification.success({icon:"sparkling",message:e.t("johannschopplich.copilot.generator.success")})}function Xt(){z==null||z.abort()}function Qt(){a({[d.value]:C.value}),C.value=void 0}async function Zt(){const w=await ye();V.value=[...V.value,...w]}async function ae(w){if(!w)return[];const{blocks:B}=await n.post("__copilot__/html2blocks",{html:w});return B.length===1&&"text"in B[0].content&&l.test(B[0].content.text)?[]:B}function le(){Ae.value&&(C.value=void 0)}function Ie(w){return p[w]||"text"}return{__sfc:!0,propsDefinition:Ce,props:t,_isKirby5:o,panel:e,api:n,t:i,currentContent:s,updateContent:a,EMPTY_HTML_TAG_RE:l,RESPONSE_FORMAT_PER_FIELD:p,label:m,field:d,userPrompt:u,systemPrompt:h,storage:v,theme:A,size:y,logLevel:x,fieldType:S,modelFile:R,help:L,config:M,isInitialized:P,isGenerating:_,isDetailsOpen:k,isBadgeHovered:N,detailsElement:q,currentPrompt:G,currentFieldContent:C,allow:se,files:V,licenseStatus:Ee,storageKey:T,abortController:z,canUndo:Ae,generate:Yt,abort:Xt,undo:Qt,pickFiles:Zt,htmlToBlocks:ae,onModelSave:le,fieldTypeToResponseFormat:Ie,LicensingButtonGroup:me,SUPPORTED_PROVIDERS:he,SUPPORTED_VISION_MIME_TYPES:ie}}});var Ut=function(){var n,i,s,a;var t=this,o=t._self._c,e=t._self._setupProxy;return e.isInitialized?o("k-section",{attrs:{label:e.label}},[e.licenseStatus!==void 0?o("template",{slot:"options"},[o(e.LicensingButtonGroup,{attrs:{label:"Kirby Copilot","api-namespace":"__copilot__","license-status":e.licenseStatus,"pricing-url":"https://kirby.tools/copilot/buy"}})],1):t._e(),!e.config.provider||!e.SUPPORTED_PROVIDERS.includes(e.config.provider)?o("k-box",{attrs:{theme:"empty"}},[o("k-text",[t._v(" Unsupported provider "),o("code",[t._v(t._s(e.config.provider))]),t._v(" in the "),o("code",[t._v("johannschopplich.copilot.provider")]),t._v(" global configuration. ")])],1):(i=(n=e.config.providers)==null?void 0:n[e.config.provider])!=null&&i.apiKey?(a=(s=e.config.providers)==null?void 0:s[e.config.provider])!=null&&a.model?e.field?e.field in e.currentContent?!e.allow.includes("edit")&&!e.userPrompt?o("k-box",{attrs:{theme:"empty"}},[o("k-text",[t._v(" If the user prompt cannot be edited by the user, a default "),o("code",[t._v("userPrompt")]),t._v(" has to be set in the section configuration. ")])],1):o("div",{staticClass:"kai-space-y-4"},[o("k-button-group",{attrs:{layout:"collapsed"}},[o("k-button",{attrs:{icon:e.isGenerating?"loader":"sparkling",text:e.panel.t("johannschopplich.copilot.generate"),theme:e.theme,variant:"filled",size:e.size,disabled:e.isGenerating},on:{click:function(l){return e.generate()}}}),e.isGenerating?o("k-button",{attrs:{icon:"cancel",text:e.panel.t("johannschopplich.copilot.stop"),theme:"notice",variant:"filled",size:e.size},on:{click:function(l){return e.abort()}}}):t._e(),e.canUndo?o("k-button",{attrs:{icon:"undo",text:e.panel.t("johannschopplich.copilot.undo"),variant:"filled",size:e.size},on:{click:function(l){return e.undo()}}}):t._e()],1),e.allow.length>0?o("details",{ref:"detailsElement",on:{toggle:function(l){e.isDetailsOpen=l.target.open}}},[o("summary",[t._v(" "+t._s([...e.allow.includes("edit")?[e.panel.t("johannschopplich.copilot.prompt.label")]:[],...e.allow.includes("files")?[e.panel.t("johannschopplich.copilot.context")]:[]].join(", "))+" ")]),o("div",{staticClass:"kai-mt-3"},[e.allow.includes("edit")?o("div",{staticClass:"kai-mb-2 kai-text-right"},[o("k-input",{key:e.isDetailsOpen?1:0,staticClass:"kai-mb-1",attrs:{value:e.currentPrompt,placeholder:e.panel.t("johannschopplich.copilot.prompt.placeholder"),type:"textarea",buttons:!1,counter:!1},on:{input:function(l){e.currentPrompt=l}}}),o("k-button",{directives:[{name:"show",rawName:"v-show",value:e.userPrompt&&e.currentPrompt!==e.userPrompt,expression:"userPrompt && currentPrompt !== userPrompt"}],attrs:{icon:"undo",text:"Reset",variant:"dimmed",size:"xs"},on:{click:function(l){e.currentPrompt=e.userPrompt}}})],1):t._e(),e.allow.includes("files")?o("div",{staticClass:"kai-relative kai-w-max"},[o("k-button",{attrs:{icon:"attachment",text:e.panel.t("johannschopplich.copilot.files.select"),variant:"filled",size:"sm"},on:{click:function(l){return e.pickFiles()}}}),e.files.length>0?o("span",{staticClass:"kai-cursor-pointer",class:[e._isKirby5?"k-button-badge kai-top-[-2px]":"k-tabs-badge kai-top-[-6px]"],attrs:{"data-theme":e.isBadgeHovered?"negative":"notice"},on:{mouseenter:function(l){e.isBadgeHovered=!0},mouseleave:function(l){e.isBadgeHovered=!1},click:function(l){e.files=[],e.isBadgeHovered=!1}}},[t._v(" "+t._s(e.isBadgeHovered?e.panel.t("johannschopplich.copilot.delete"):e.files.length)+" ")]):t._e()],1):e.modelFile?o("k-box",{attrs:{theme:"none"}},[o("k-text",[t._v(" "+t._s(e.panel.t(`johannschopplich.copilot.context.file.${e.SUPPORTED_VISION_MIME_TYPES.includes(e.modelFile.mime)?"model":"unsupported"}`))+" ")])],1):t._e()],1)]):t._e()],1):o("k-box",{attrs:{theme:"empty"}},[o("k-text",[t._v(" The "),o("code",[t._v(t._s(e.field))]),t._v(" field does not exist in the current model. ")])],1):o("k-box",{attrs:{theme:"empty"}},[o("k-text",[t._v(" Missing "),o("code",[t._v("field")]),t._v(" property in the section configuration. It is required for the generated text. ")])],1):o("k-box",{attrs:{theme:"empty"}},[o("k-text",[t._v(" Missing "),o("code",[t._v("model")]),t._v(" property in the "),o("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1):o("k-box",{attrs:{theme:"empty"}},[o("k-text",[t._v(" Missing "),o("code",[t._v("apiKey")]),t._v(" property in the "),o("code",[t._v(t._s(`johannschopplich.copilot.providers.${e.config.provider}`))]),t._v(" global configuration. ")])],1),e.help?o("footer",{staticClass:"kai-mt-[var(--spacing-2)]"},[o("k-text",{staticClass:"k-help",attrs:{html:e.help}})],1):t._e()],2):t._e()},Kt=[],Ht=Q(Dt,Ut,Kt,!1,null,null);const Nt=Ht.exports;async function Be(r,{appendText:t,replaceText:o,responseFormat:e="text"}){const n=b(),i=new AbortController,s=u=>{u.key==="Escape"&&i.abort()},a=await qt({selection:r});if(!a)return;const{prompt:l,files:p}=a;if(!l)return;n.isLoading=!0,document.addEventListener("keydown",s),await ee();const{AISDKError:m,APICallError:d}=await X("ai");try{const{textStream:u}=await ve({userPrompt:[l,`<response_format>
${e}
</response_format>`,r&&`<selected_text>
${r}
</selected_text>`].filter(Boolean).join(`

`),systemPrompt:ge,files:p,abortSignal:i.signal});let h=!0;for await(let v of u)a.append?(h&&(v=r?` ${v}`:v,h=!1),t(v)):o(v);n.notification.success({icon:"sparkling",message:n.t("johannschopplich.copilot.generator.success")})}catch(u){if(u instanceof Error&&(u.name==="AbortError"||u.name==="TimeoutError"))return;if(u instanceof U||m.isInstance(u)||d.isInstance(u)){console.error(u),n.notification.error(u.message);return}console.error(u),n.notification.error(n.t("johannschopplich.copilot.generator.error"))}finally{n.isLoading=!1,document.removeEventListener("keydown",s)}}async function qt(r={}){return new Promise(t=>{const o=b();let e;o.dialog.open({component:"k-copilot-prompt-dialog",props:r,on:{close:()=>{setTimeout(()=>{t(e)},25)},submit:n=>{e=n,o.dialog.close()}}})})}const Gt={copilot:{icon:"sparkling",label:"Copilot Prompt",click(){let r="";this.command("insert",(n,i)=>(r=i,i));let t=!0;Be(r,{responseFormat:"markdown",appendText:n=>{this.command("insert",(i,s)=>t?(t=!1,s+n):n)},replaceText:n=>{this.command("insert",()=>n)}})},shortcut:"."}},Le={"***":["bold","italic"],"**":["bold"],"*":["italic"],"`":["code"]},Vt={copilot:{get button(){return{icon:"sparkling",label:"Copilot Prompt"}},commands(r){return()=>this._openPromptDialog(r)},keys(r){return{"Mod-.":()=>this._openPromptDialog(r)}},get name(){return"copilot"},_insertText(r,t,o,e,n){let i=o;const s=t.split(/(\n\n?|\*{1,3}|`{1,3})/);for(const a of s)if(a===`

`)r=r.replaceWith(i,i,this.editor.options.inline?[n.schema.nodes.hardBreak.create(),n.schema.nodes.hardBreak.create()]:n.schema.nodes.paragraph.create()),i+=2;else if(a===`
`)r=r.replaceWith(i,i,n.schema.nodes.hardBreak.create()),i+=1;else if(a.length>0){if(a in Le&&!e.lastSegment.includes(a)||[...e.activeMarks].some(l=>l.type.name===a)){for(const l of Le[a])r=Wt(r,l,e,n);e.lastSegment=a;continue}r=r.insertText(a,i),i+=a.length,e.lastSegment=a}return{tr:r,newPosition:i}},_openPromptDialog(r){const{state:t}=this.editor,{from:o,to:e}=t.selection,n=t.doc.textBetween(o,e),i={activeMarks:new Set,lastSegment:""};let s,a=!1;Be(n,{responseFormat:"text",replaceText:m=>{const{state:d,view:u}=this.editor;let h=d.tr;if(!a){const y=Jt(d),{from:x,to:S}=d.selection;h=h.deleteRange(x,S),s=y?1:x,a=!0}const{tr:v,newPosition:A}=this._insertText(h,m,s,i,r);s=A,u.dispatch(v)},appendText:m=>{const{state:d,view:u}=this.editor;s=d.selection.to;const{tr:h,newPosition:v}=this._insertText(d.tr,m,s,i,r);s=v,u.dispatch(h)}})}}};function Wt(r,t,o,{schema:e}){if([...o.activeMarks].some(n=>n.type.name===t)){o.activeMarks.delete(t);const n=[...o.activeMarks].filter(i=>i.type.name!==t);return r.setStoredMarks(n)}else{const n=e.marks[t].create();return o.activeMarks.add(n),r.addStoredMark(n)}}function Jt(r){const t=r.doc.content.size,{from:o,to:e}=r.selection;return o===0&&e===t}window.panel.plugin("johannschopplich/copilot",{components:{"k-copilot-prompt-dialog":Rt},sections:{copilot:Nt},fields:{},textareaButtons:Gt,writerMarks:Vt})})();
